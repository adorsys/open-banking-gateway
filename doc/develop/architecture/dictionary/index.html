<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Dictionary - Open Banking Gateway Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Dictionary";
    var mkdocs_page_input_path = "architecture/dictionary.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Open Banking Gateway Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../roadmap/">Roadmap</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../releasenotes/">Release notes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../drafts/initial_requirements/">Initial Requirements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Architecture</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../1-loginWithFinTech/">Login with FinTech Application</a>
                </li>
                <li class="">
                    
    <a class="" href="../2-searchBank/">Search bank</a>
                </li>
                <li class="">
                    
    <a class="" href="../3-selectBank/">Select bank</a>
                </li>
                <li class="">
                    
    <a class="" href="../4-initiateAisConsent/">List of Transactions</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-redirectPsuToConsentAPI/">Redirect to Consent Authorization API</a>
                </li>
                <li class="">
                    
    <a class="" href="../5a-psuAuthEmbeddedConsent/">Authorize Consent Embedded Approach</a>
                </li>
                <li class="">
                    
    <a class="" href="../5b-psuAuthRedirectConsent/">Authorize Consent Redirect Approach</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-consume_api/">Consume Service</a>
                </li>
                <li class="">
                    
    <a class="" href="../drafts/initial_requirements/">Draft</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Open Banking Gateway Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Dictionary</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/adorsys/open-banking-gateway/edit/master/docs/architecture/dictionary.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="dictionary">Dictionary</h1>
<ul>
<li><a href="./#AisConsentSpec">AisConsentSpec</a></li>
<li><a href="./#App">App</a></li>
<li><a href="./#AspspBankingApi">AspspBankingApi</a></li>
<li><a href="./#BankDescriptor">BankDescriptor</a></li>
<li><a href="./#BankingProtocol">BankingProtocol</a></li>
<li><a href="./#BankProfile">BankProfile</a></li>
<li><a href="./#Center">Center</a></li>
<li><a href="./#Center">Center</a></li>
<li><a href="./#ConsentAuthorisationApi">ConsentAuthorisationApi</a></li>
<li><a href="./#ConsentAuthorisationUI">ConsentAuthorisationUI</a></li>
<li><a href="./#ConsentAuthSessionCookie">ConsentAuthSessionCookie</a></li>
<li><a href="./#consentAuthState">consentAuthState</a></li>
<li><a href="./#ConsentData">ConsentData</a></li>
<li><a href="./#Considerations">Considerations</a></li>
<li><a href="./#Dictionary">Dictionary</a></li>
<li><a href="./#Fintech2TppRedirectInfoPage">Fintech2TppRedirectInfoPage</a></li>
<li><a href="./#FinTechApi">FinTechApi</a></li>
<li><a href="./#FinTechContext">FinTechContext</a></li>
<li><a href="./#FinTechDC">FinTechDC</a></li>
<li><a href="./#FinTechLoginSessionCookie">FinTechLoginSessionCookie</a></li>
<li><a href="./#FinTechLoginSessionState">FinTechLoginSessionState</a></li>
<li><a href="./#FinTechUI">FinTechUI</a></li>
<li><a href="./#Information">Information</a></li>
<li><a href="./#OnlineBanking2ConsentAuthRedirectInfoPage">OnlineBanking2ConsentAuthRedirectInfoPage</a></li>
<li><a href="./#OnlineBankingApi">OnlineBankingApi</a></li>
<li><a href="./#OnlineBankingConsentSessionCookie">OnlineBankingConsentSessionCookie</a></li>
<li><a href="./#OnlineBankingLoginSessionCookie">OnlineBankingLoginSessionCookie</a></li>
<li><a href="./#OnlineBankingUI">OnlineBankingUI</a></li>
<li><a href="./#PSU">PSU</a></li>
<li><a href="./#PsuConsentSession">PsuConsentSession</a></li>
<li><a href="./#PsuIdentifier">PsuIdentifier</a></li>
<li><a href="./#PsuUserAgent">PsuUserAgent</a></li>
<li><a href="./#PsuUserDevice">PsuUserDevice</a></li>
<li><a href="./#Redirection">Redirection</a></li>
<li><a href="./#RedirectSessionStoreApi">RedirectSessionStoreApi</a></li>
<li><a href="./#RedirectSession">RedirectSession</a></li>
<li><a href="./#Sharing">Sharing</a></li>
<li><a href="./#TppBankingApi">TppBankingApi</a></li>
<li><a href="./#TppBankSearchApi">TppBankSearchApi</a></li>
<li><a href="./#TppConsentSession">TppConsentSession</a></li>
<li><a href="./#TppContext">TppContext</a></li>
<li><a href="./#TPP">TPP</a></li>
<li><a href="./#UserAgentContext">UserAgentContext</a></li>
<li><a href="./#WebBrowser">WebBrowser</a></li>
</ul>
<h2 id="psu-payment-service-user"><a name="PSU"></a>PSU (Payment Service User)</h2>
<p>A Payment Service User is any natural person that make uses a payment service on behalf of himself or on behalf of a legal person.</p>
<h3 id="properties-of-a-psu">Properties of a PSU</h3>
<ul>
<li>A PSU is a natural person</li>
<li>A PSU is in possession of some personal non sharable online banking credentials</li>
<li>A PSU uses applications running on some devices to interact with online services</li>
</ul>
<h3 id="identities-of-a-psu"><a name="PsuIdentifier"></a>Identities of a PSU</h3>
<p>In the context of OpenBanking, a PSU might be interacting with up to three different legal entities to consume a single service. In the service chain, we will generally a <a href="./#FinTech">FinTech</a>, a <a href="./#TPP">TPP</a> and the <a href="./#ASPSP">ASPSP</a>. </p>
<p>The OpenBanking contract establishes a relationship between the the <strong>PSU</strong>, the <strong>TPP</strong> and the <strong>ASPSP</strong>. This contract is mapped in the following sentence: "<strong>PSU</strong> <strong>consents</strong> to the <strong>ASPSP</strong> to service requests from a designated <strong>TPP</strong> on his behalf".</p>
<p>Market practice shows that special independent TPPs will be setup to service multiple FinTechs (Agents). This still does not change the OpenBanking contract, extends the contract to the following sentence:"<strong>PSU</strong> also <strong>consents</strong> to the <strong>TPP</strong> to  service requests from a designated <strong>FinTech</strong> on his behalf.</p>
<p>At the end, we have the following service chain: PSU -&gt; FinTech -&gt; TPP -&gt; ASPSP that might also require following interactions (PSU -&gt; FinTech), (PSU -&gt; TPP), (PSU -&gt; ASPSP), resulting in the PSU having to maintain up to 3 different identities.</p>
<p><img alt="Component diagram" src="http://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/adorsys/open-banking-gateway/develop/docs/architecture/diagrams/components/psu-identities.puml&amp;fmt=svg&amp;vvv=1&amp;sanitize=true" /></p>
<h4 id="psu-idfintech">psu-id@fintech</h4>
<p>This is the identity of the PSU in the realm of the FinTech, as most FinTech application require the PSU to establish an identity before using the application. This is the most important identity as it covers the consumption of the core services. Further identities (tpp, aspsp) are only needed for authorization. </p>
<p>This framework is designed such as to request the FinTech to provide a permanent unique identity of each PSU to the TPP. This is what we call the <strong>psu-id@fintech</strong> </p>
<h4 id="psu-idtpp">psu-id@tpp</h4>
<p>This is the PSU as known to the TPP. If TPP environment is designed to service a single FinTech, this identity can be set equal to the <strong>psu-id@fintech</strong>.</p>
<p>If a TPPenvironment services multiple FinTech entities, the TPP will have to establish a separated PSU identity that references all corresponding FinTech identities. This requirement only exists because some OpenBanking specifications do not allow TPP to maintain multiple valid consents of the same type on the same bank account.</p>
<p>In a situation where the TPP uses the same account information consent to service many FinTech, a TPP consent management layer must allow a PSU to revoke that consent for a designated FinTech without revoking the consent at the ASPSP level. </p>
<h4 id="psu-idaspsp">psu-id@aspsp</h4>
<p>This is the identity of the PSU as known to the ASPSP. This identity generally matches an online banking identifier in the realm of the ASPSP.</p>
<h2 id="psuuserdevice"><a name="PsuUserDevice"></a>PsuUserDevice</h2>
<p>A PsuUserDevice runs applications used by the PSU to access banking functionality. Those applications are generally called PsuUserAgents.</p>
<h3 id="psuuseragent"><a name="PsuUserAgent"></a>PsuUserAgent</h3>
<p>A PsuUserAgent is an application running on a user device and used by the PSU to access banking functionality. PsuUserAgents are either Web application running on a standard web browser or native applications.</p>
<p>We distinguish among two types of PsuUserAgents.</p>
<h4 id="webbrowser-based-useragent">WebBrowser based UserAgent</h4>
<p>A WebBrowser is considered compliant in the context of this framework when it can protect specific information used between the PsuUserDevice and the the corresponding server application to track the user session. For session tracking, this framework uses <a href="https://tools.ietf.org/html/rfc6265">Cookies RFC6265</a>. </p>
<h4 id="native-applications">Native Applications</h4>
<p>The UserAgent might be a native application running on a user mobile device or a desktop computer. In this case, redirection might still take place, but with consideration of the physical transition between source and target UI-Application. Following specifications deal with security threads associated with the redirection between UI-Application on a user device: <a href="https://tools.ietf.org/html/rfc8252">RFC8252:OAuth 2.0 for Native Apps</a>,<a href="https://tools.ietf.org/html/rfc7636">RFC7636:Proof Key for Code Exchange by OAuth Public Clients</a>.</p>
<p>For the purpose of keeping the overall architecture of this framework simple, we require native applications to provide the same behavior as the Web Browser based user agents described above.</p>
<h4 id="useragentcontext"><a name="UserAgentContext"></a> UserAgentContext</h4>
<p>Independent on the type of user agent, OpenBanking interfaces will require a class of information associated with the PsuUserAgent so they can perform verification of the authenticity of the original PSU request and customize the response produced for intermediary layers. 
We group these Data under the name "UserAgentContext" and they and they are among other: IP-Address, IP-Port, Accept, Accept-Charset, Accept-Encoding, Accept-Language, Device-ID, User-Agent, Geo-Location, Http-Method.</p>
<h3 id="security-considerations">Security Considerations</h3>
<h4 id="cookies"><a name="Cookies"></a> Cookies</h4>
<p>The use of cookies provides the most elaborated way to protect a session established between a user agent and server application. We assume a user agent storing a cookie fulfills following requirements:
- The user agent store cookies on the user device in the context of a user session. Means if two users are sharing the same user device, cookies stored by those users wont be mixed up with each order.
- Cookies carrying the attribute <strong>HttpOnly</strong> are not provided access to scripts run by the browser based UserAgent. This requirement can not be enforced for mobile application. For that reason, mobile application will be passed under thorough security review before released for public use.
- Cookies carrying the attribute <strong>Secure</strong> are only sent to the server over SSL connections.
- Expired Cookies (attribute <strong>Expires</strong>) are not sent to the server.
- Cookies shall never be transmitted to a domain not matching it origin
- In the same domain, cookies shall only be transmitted to the configured path.</p>
<h4 id="redirection"><a name="Redirection"></a> Redirection</h4>
<p>The server can request the user agent to redirect the user to another application by returning a 302 response code to the user agent. Redirection can generally happen in the same user agent environment (process) or can open a another user agent depending on the URL policy configured on the user device. For example depending on the protocol of the location URL, a redirection from a WebBrowser might open a NativeApp or vice versa. For this reason, any information to be carried by the redirection has to be part of the location URL.</p>
<p>We will be using redirection to switch the user context from one application to another one. Following redirection will generally be found in this framework:
- FinTechApi to-&gt; ConsentAuthorisationApi
- ConsentAuthorisationApi to-&gt; OnlineBankingApi
- OnlineBankingApi backTo-&gt; ConsentAuthorisationApi
- ConsentAuthorisationApi backTo-&gt; FinTechApi</p>
<h4 id="redirection-and-data-sharing"><a name="Redirection_Data_Sharing"></a>Redirection and Data Sharing</h4>
<p>We assume all three applications FinTechApi, ConsentAuthorisationApi, OnlineBankingApi are hosted on different domains. This is, we are not expecting cookies set by one application to be visible to another application (this might still happen on some local development environment, where everything runs on localhost). </p>
<p>We also do not advice adding persistent information to Location URL (<strong>RedirectUrl</strong>), as these are logged in files everywhere on infrastructure components in data centers.</p>
<ul>
<li>If we have any bulky information to share between the source application and the target application, we can add a <strong>OneTime</strong> and <strong>ShortLived</strong> authorization code we call <strong>redirectCode</strong> to <strong>RedirectUrl</strong>. This redirectCode can be used to retrieved shared payload through an authenticated back channel connection. This is the practice borrowed from <a href="https://tools.ietf.org/html/rfc6749">oAuth2 RFC6749</a>.</li>
<li>If we want to make sure the user is redirected back to the original user device, we can set a RedirectCookie while returning 302 to the source user agent. In this case, the url used by the target user agent to redirect the user back to the source user agent must:</li>
<li>carry a path information (e.g. /consent/{auth-id}) that allows retransmission of the redirectCookie to the source, and</li>
<li>carry a redirectState (e.g. /consent/{auth-id}/fromAspsp/{redirectState}) that can be used as XSRF token for the validation of the redirect cookie.</li>
</ul>
<h4 id="sessioncookie-and-xsrf"><a name="SessionCookie"></a> SessionCookie and XSRF</h4>
<p>We assume all three applications FinTeApi, ConsentAuthorisationApi, OnlineBakingApi maintain their own session information with corresponding UIs. We assume those APIs use cookies to maintain session with the corresponding user agents. In the context of this framework, those cookies are called SessionCookies. We also expect a following behavior from APIs and UserAgents:</p>
<ul>
<li>A response that sets a SessionCookie also carries a corresponding X-XSRF-TOKEN in the response header.</li>
<li>A request that authenticates with a session cookie must also add the X-XSRF-TOKEN to the request header.</li>
</ul>
<h3 id="psuconsentsession"><a name="PsuConsentSession"></a> PsuConsentSession</h3>
<p>Once a consent authorization process is initiated by the TppBankingApi (Over the FinTechApi), we want to make sure that the PSU giving his consent (psu-id@tpp, psu-id@aspsp), is the same as the PSU requesting the service on the FinTechApi interface (psu-id@fintech).</p>
<p>Ensuring the equivalence of those identities can be represented as (assuming alice and bob are PSU):</p>
<pre><code>alice@fintech ==&gt; alice@tpp ==&gt; alice@aspsp 

// Where alice@fintech ==&gt; alice@tpp neans The person identified at the FinTechApi as alice@fintech 
// owns the necessary credentials used to identify at the ConsentAuthorisationApi as alice@tpp

</code></pre>

<p>This is the most challenging task to be solved by this framework. This is, the integrity of the OpenBanking solution is broken when security breaches can be used to compromise equivalences like:</p>
<pre><code>bob@fintech ==&gt; alice@tpp ==&gt; alice@aspsp 
// although in reality  bob@fintech =/=&gt; alice@tpp 

</code></pre>

<p>In this case bob identifies with the FinTechApi (as bob@fintech) but manipulates alice to identify with the ConsentAuthorisationApi and provide her consent for the requested banking service. </p>
<pre><code>
bob@fintech ==&gt; bob@tpp ==&gt; alice@aspsp 
// although in reality  bob@tpp =/=&gt; alice@aspsp

</code></pre>

<p>In this case bob identifies with the FinTechApi and the ConsentAuthorisationApi but manipulates alice to identify with the OnlieBankingApi and provide her consent for the requested banking service. </p>
<p>The biggest challenge we will be facing is to make sure:
- In case of an SCA redirect/oauth/decoupled, the natural person (online banking account) that provides a consent at the OnlineBankingApi of the ASPSP (alice@aspsp) is also the one that initiated the underlying banking service at the FinTech (alice@fintech). Whereby "<strong>is also the one</strong>" is equivalent to "<strong>owns the necessary credentials</strong>".
- In case of an SCA embedded, the natural person (online banking account) that provides her consent at the TTP ConsentAuthorisationApi (alice@tpp) is also the one that initiated the underlying banking service at the FinTechApi interface (alice@fintech). Whereby "<strong>is also the one</strong>" is equivalent to "<strong>owns the necessary credentials</strong>".</p>
<h4 id="step-1-identify-psu-at-the-fintechapi">Step-1: Identify PSU at the FinTechApi</h4>
<p>We always expect the PSU to be identified at the FinTechApi interface. So we assume that the psu-id@fintech is known. The integrity of the rest of the framework relys on the capability of the FinTech to protect the session associating the PSU to the FinTechApi.</p>
<p>The service request itself is always initiated by the FinTechApi. Before initiation, we assume that the PSU (alice) has signed into the FinTechApi and her identity is known to the FinTechApi and thus associated with the service request forwarded to the TppBankingApi.</p>
<h4 id="step-2-store-psu-idfintech-with-the-consentauthorizationsession">Step-2: Store psu-id@fintech with the ConsentAuthorizationSession</h4>
<p>While processing a service request, if the TppBankingApi notices that the service request is not covered by a consent (either as a result of pre-checking the consent or from an error returned by the OpenBankingApi), the TppBankingApi will trigger a new ConsentAuthorizationSession. </p>
<p>Starting a new ConsentAuthorizationSession, we require the TppBankingApi to store the identity of service requesting PSU alice@fintech with the ConsentAuthorizationSession record before initiating a redirect to the ConsentAuthorisationApi.</p>
<p>This is, the ConsentAuthorizationSession record stored in the TPP Database will have the form </p>
<pre><code>[auth-id,redirectCode]=ConsentAuthorizationSession[auth-id,redirectCode, alice@fintech, ConsentData]
// Where redirectCode is a one time key.
// Where auth-id is the identifier of this ConsentAuthorizationSession

</code></pre>

<p>where the redirectCode can be used by the ConsentAuthorisationApi once to retrieve the ConsentAuthorizationSession.</p>
<h4 id="step-2-identify-psu-at-the-tpp-consentauthorisationapi">Step-2: Identify PSU at the TPP ConsentAuthorisationApi</h4>
<p>At first, redirecting a PSU from the FinTechApi to the TPP ConsentAuthorisationApi does not establish any relationship between the PSU and the TPP, even if we can use the redirectCode associated with the redirected url to retrieve ConsentAuthorisationSession. Off course the ConsentAuthorisationApi knows that the ConsentAuthorizationSession was initiated by alice@fintech, but this does not mean that the PSU controlling the current UserAgent (known as ConsentAuthorisationUI) is the same natural person as alice@fintech. </p>
<p>In order to proceed with the ConsentAuthorisationSession, the TPP ConsentAuthorisationApi will have to establish an identification of the natural person controlling the UserAgent(implicit or explicit), resulting in a new PSU identity called (psu-id@tpp). This PSU identity (psu-id@tpp) will also be associated with the ConsentAuthorisationSession.</p>
<p>At this stage, the ConsentAuthorizationSession record stored in the TPP Database will have the form: </p>
<pre><code>[auth-id,redirectCode]=ConsentAuthorizationSession[auth-id,redirectCode, alice@fintech, alice123@tpp, ConsentData]
// But with the assumption that alice@fintech =/=&gt; alice123@tpp. 
// Meaning that both identities are not yet verified equivalent (owned by the same natural person)

</code></pre>

<p>Even though the ConsentAuthorizationSession in the TPP database is associated with two identities (alice@fintech and alice123@tpp), there is no proof what so ever that alice@fintech and alice123@tpp are controlled by the same natural person.</p>
<p>The process continues with the addition of the psu-id@aspsp.</p>
<p>In an Embedded-SCA case, the psu-id@aspsp is collected by the ConsentAuthorisationApi and forwarded to the OpenBankingApi of the ASPSP. In this case it is easy to assume uniqueness between both psu-id@tpp and psu-id@aspsp. This will result in the following record after a successful embedded consent authorization at the ConsentAuthorisationApi:</p>
<pre><code>[auth-id,redirectCode]=ConsentAuthorizationSession[auth-id,redirectCode, alice@fintech, alice123@tpp, alice-s@aspsp, ConsentData]
// alice@fintech =/=&gt; alice123@tpp. // Meaning that both identities are not yet verified equivalent (owned by the same natural person)
// alice123@tpp ==&gt; alice-s@aspsp. // Meaning alice123@tpp could provide the banking credentials of alice-s@aspsp.

</code></pre>

<p>Even in this embedded case, there is still a missing equivalence between alice@fintech and alice-s@tpp.</p>
<h4 id="step-3-identify-psu-at-the-aspsps-onlinebankingapi">Step-3: Identify PSU at the ASPSP's OnlineBankingApi</h4>
<p>In a Redirect-SCA case (oauth, redirect, decoupled), the PSU will have to be redirected by the ConsentAuthorisationApi to the OnlienBanking interface of the ASPSP. After a successful consent authorization at the OnlienBanking interface, the record could be updated by the mean of poling the authorization status of this ConsentAuthorizationSession at the OpenBankingApi of the ASPSP. In this case the ConsentAuthorizationSession will look like:   </p>
<pre><code>[auth-id,redirectCode]=ConsentAuthorizationSession[auth-id,redirectCode, alice@fintech, alice123@tpp, alice-s@aspsp, ConsentData]
// alice@fintech =/=&gt; alice123@tpp. // Meaning that both identities are not yet verified equivalent (owned by the same natural person)
// alice123@tpp =/=&gt; alice-s@aspsp. // Meaning that both identities are not yet verified equivalent (owned by the same natural person)

</code></pre>

<h4 id="step-4-verify-equivalence-between-psu-idaspsp-and-psu-idtpp">Step-4: Verify Equivalence between psu-id@aspsp and psu-id@tpp</h4>
<p>After a successful consent authorization at the OnlineBankingApi of the ASPSP, the framework has to ensure equivalence between the PSU identified at the TPP and the PSU identified at the ASPSP.</p>
<p>In this framework, we designed a two steps redirection FinTech -&gt; TPP -&gt; ASPSP knowing that this might make the process more cumbersome, but this design represents the superset of most of the cases found on the market. After thorough analysis of most scenarios, we noticed that the identity equivalence process can only securely happen in one of these ways:</p>
<h5 id="step-4-alt-1-sharing-of-idp-identity-provider">Step-4 Alt-1: Sharing of IDP (Identity Provider)</h5>
<p>If TPP and ASPSP can rely on the same IDP to identify the PSU, the identity association process will be simple as the IDP will provide a common identifier. For example the subject claim of an id-token leading to subject(alice123@tpp)==subject(alice-s@aspsp).</p>
<h5 id="step-4-alt-2-no-sharing-of-idp-identity-provider">Step-4 Alt-2: No Sharing of IDP (Identity Provider)</h5>
<p>If the TPP and ASPSP can not share the same identity provider, a <strong>back redirection</strong> from the ASPSP to the TPP must be used to help complete the identity verification. Note that the physical <strong>back redirection</strong> will not be possible in the decouple approach.</p>
<p>Following sub-steps will be needed to ensure clean and secure back redirection:
- A RedirectCookie must have been set on the PsuUserAgent while redirecting a user from the TPP (ConsentAuthorisationApi) to the ASPSP (OnlineBankingApi).
- The url for the <strong>back redirection</strong> must have been protected against manipulation: 
  - In case there is an initiation step present between TPP and ASPSP, use this step to transfer the <strong>back redirection url</strong> to the ASPSP (this is an example of the redirect approach of the NextGenPSD2 API).
  - In case there is no such initiation step (generally when OAuth is being used), make sure oAuth2 <strong>back redirection url templates</strong> and <strong>webOrigins</strong> are properly designed as the concrete <strong>back redirection url</strong> is transported with the consent request and exposed to attackers manipulations.
- Design the <strong>back redirection url</strong> to contain a reference of the RedirectCookie (auth-id) and a corresponding XSRF-token (redirectState) for the validation of the RedirectCookie. A sample url can look like: /consent/{auth-id}/fromAspsp/{redirectState}/ok. See <a href="./#Redirection_Data_Sharing">Redirection and Data Sharing</a> for more detail.</p>
<p>If a physical redirect can occur from the ASPSP (OnlineBankingApi) back to the TPP (ConsentAuthorisationApi), <strong>a validation of the original RedirectCookie can be taken as a guaranty to declare equivalence between the psu-id@tpp and the psu-id@aspsp</strong>.</p>
<h5 id="step-4-alt-3-no-sharing-of-idp-and-decoupled-approach">Step-4 Alt-3: No Sharing of IDP and Decoupled Approach</h5>
<p>For the decoupled approach, there is no way to provide a physical back redirect from the ASPSP to the TPP. So innovative data sharing methods are necessary to verify equivalence of both psu-id@tpp and psu-id@aspsp. This framework suggests the sharing of a QR-Code image as a mean of ensuring that the natural person in control of the ConsentAuthorisationApi is the same as the one in control of the OnlineBankingMobileApp used to execute the decoupled consent authorization against the OnlineBankingApi.
- If the PSU is using a desktop to request the banking service, the decoupled consent authorization on the OnlineBankingMobileApp will starts by mean of the PSU scanning a QR-Code displayed on the user desktop by the ConsentAuthorisationUI.
- If both ConsentAuthorisationUI and OnlineBankingMobileApp are running on the same user device, App to App physical redirection will be preferable. Turning this decoupled approach into a redirect approach. If App to App physical redirection is not possible, mobile device image sharing routines can be used to push the QR-Code produced by the ConsentAuthorisationApi to the decoupled OnlineBankingMobileApp.</p>
<h4 id="step-5-verify-equivalence-between-psu-idtpp-and-psu-idfintech">Step-5: Verify Equivalence between psu-id@tpp and psu-id@fintech</h4>
<p>We assume that there is a physical redirection possibility from the ConsentAuthorisationApi back to the FinTechApi. This assumption is based on the fact that there is a better synchronization between a TPP and FinTech using it's services. This is, the same principles described in "Step-4 Alt-1" and "Step-4 Alt-2" apply.</p>
<h4 id="consent-authorization-identity-equivalence-and-service-execution">Consent Authorization, Identity Equivalence and Service Execution</h4>
<p>In some OpenBanking approaches, validating the consent at the OnlineBanking interface of the ASPSP directly finalizes authorization of the service request. The NextGenPSD2 specification finalizes a payment initiation with the act of a PSU authorizing the payment consent (either on the ASPSP or TPP interface). But at this stage, the identity equivalence verification described above might not have happened yet leaving the process incomplete.</p>
<p>This is a weakness in the process design as there can be no guaranty of a matching association between <strong>PSU identity of the TPP</strong> PSU and <strong>PSU identity of ASPSP</strong> before a final verification of the identity equivalence.</p>
<p>In order to fix this problem, concerned OpenBankingApi (like the NextGenPSD2) will have to be modified to separate consent authorization from service request. 
- A consent authorization is always finalized with the verification of the identity equivalence (psu-id@fintech==&gt; psu-id@tpp ==&gt; psu-id@aspsp).
- The FinTechApi will then re-send the service request to the TppBankingApi
- TppBankingApi will only forward service request to ASPSP's OpenBankingApi if the corresponding consent is legitimate (meaning if identity equivalence verification was successful).</p>
<h3 id="applications-running-on-a-user-device">Applications Running on a User Device</h3>
<h4 id="fintechui"><a name="FinTechUI"></a> FinTechUI</h4>
<p>UI Application running on the PsuUserAgent and used by the PSU to access the FinTechApi</p>
<h4 id="consentauthorisationui"><a name="ConsentAuthorisationUI"></a> ConsentAuthorisationUI</h4>
<p>UI used by PSU to authorize consent in embedded case.</p>
<h4 id="onlinebankingui"><a name="OnlineBankingUI"></a> OnlineBankingUI</h4>
<p>This UI manages the interaction between the PSU and the ASPSP in redirect cases.</p>
<h2 id="fintech-data-center"><a name="FinTechDC"></a> FinTech Data Center</h2>
<p>Data center environment of the FinTech. Host the FinTechApi.</p>
<h3 id="fintechapi"><a name="FinTechApi"></a> FinTechApi</h3>
<p>Financial web service provided by the FinTech.</p>
<h3 id="fintechloginsessioncookie"><a name="FinTechLoginSessionCookie"></a> FinTechLoginSessionCookie</h3>
<p>This is a SessionCookie used to maintain the login session between the FinTechUI and the FinTechApi. As this maintains the login state of the PSU in the FinTechUI, this session can be kept open for the life span of the interaction between the FinTechUI and the FinTechApi.</p>
<p>There is a X-XSRF-TOKEN String associated with the FinTechLoginSessionCookie. This information must be presented whenever the FinTechApi consumes the FinTechLoginSessionCookie. The X-XSRF-TOKEN encodes a key that is used to validate (evtl. encrypt/decrypt) information stored in the corresponding FinTechLoginSessionCookie.</p>
<h2 id="tpp-data-center"><a name="TppDC"></a> Tpp Data Center</h2>
<p>Data center environment of the TPP</p>
<h3 id="tpp"><a name="TPP"></a> TPP</h3>
<p>A TPP is a Third Party Provider.</p>
<h3 id="tppbankingapi"><a name="TppBankingApi"></a> TppBankingApi</h3>
<p>Tpp backend providing access to ASPSP banking functionality. This interface is not directly accessed by the PSU but by the FinTechApi. FinTechApi will use a FinTechContext to authenticate with the TppBankingApi.</p>
<h3 id="tppbanksearchapi"><a name="TppBankSearchApi"></a> TppBankSearchApi</h3>
<p>Repository of banks maintained in the TPP's banking gateway. The banking search API will later present an interface to configure profiles attached to listed banks.</p>
<h3 id="bankdescriptor"><a name="BankDescriptor"></a> BankDescriptor</h3>
<p>Descriptive information associated with a bank like:
- The name of the Bank
- The address of the bank
- The bank identification code</p>
<h3 id="bankprofile"><a name="BankProfile"></a> BankProfile</h3>
<p>BankingApi profile information associated with a bank like:
- The BankingProtocol used to connect with the bank
- List of Banking services provided by the BankingApi of the bank
- SCA approaches associated with the BankingApi
- ScaUIMetadaData: Screens and field used to collect user authentication data.
- Actions to be performed by the PSU prior to using the BankingProtocol</p>
<h4 id="aisconsentspec"><a name="AisConsentSpec"></a> AisConsentSpec</h4>
<p>Specification associated with an AisConsent. This is highly dependent on the BankProfile. Following information might be carried by an AisConsentSpec object:
- recurringIndicator
- validUntil
- frequencyPerDay
- combinedService
- accountAccessTemplate
- availableAccounts[availableAccountsWithBalances, allAccounts]
- allPsd2[allAccounts]</p>
<h3 id="consentdata"><a name="ConsentData"></a> ConsentData</h3>
<p>In the context of OpenBanking, a consent encompasses all information necessary to provide a third party with the authorization to access banking services on behalf of the PSU. These are:
- PSU banking identifier information known as (psu-id@aspsp or psuId, psuCorporateId)
- PSU account details information (like account numbers, iban, ...)
- PSU payment orders (including beneficiary names, amounts, ...)
- PSU authentication methods</p>
<p>All these information are stored in different devices during the consent authorization session. Form of storages are among others:
- Held in the browser page for display to the PSU
- Stored in the Cookie for reuse by the corresponding backend
- Stored in backend databases for transfer to other server components
- Stored in backend databases for reuse by server components.</p>
<p>For the purpose of protecting these data, framework is designed to always have consent data encrypted while at rest or on transit. General logic is that encrypted payload and encryption key do not reside in the same environment, unless needed for decryption and processing of those data.</p>
<p>Following object hold consent data
- <a href="./#TppConsentSession">TppConsentSession</a>: Stores consent data in the database of the TPP. 
- <a href="./#RedirectSession">RedirectSession</a> : Temporary storage of consent data when PSU is being redirected between FinTech, TPP and ASPSP.
- <a href="./#PsuConsentSession">PsuConsentSession</a> : This is only the reference to the TppConsentSession for a given FinTech. As the same TppConsentSession might be shared among many FinTechs.</p>
<h3 id="fintechcontext"><a name="FinTechContext"></a> FinTechContext</h3>
<p>Information used to identify the FinTech application at the TppBankingApi. For example a FinTech SSL client certificate or an APIKey or an oAuth2 Password Grant Credential.</p>
<p>FinTechContext might also contain FinTEch specific Information like:
- Data needed to customize PSU access at the ConsentAuthorisationApi (showInfoFlag)
- Data needed to manage redirection of PSU back from the ConsentAuthorizeApi to the FintechApi like (FinTech-Redirect-URI-Template, FinTech-Nok-Redirect-URI-Template, FinTech-Explicit-Authorisation-Preferred, FinTech-Content-Negotiation)</p>
<h3 id="consentauthorisationapi"><a name="ConsentAuthorisationApi"></a> ConsentAuthorisationApi</h3>
<p>Interface used by the PSU to authorize a consent.</p>
<h3 id="consentauthsessioncookie"><a name="ConsentAuthSessionCookie"></a> ConsentAuthSessionCookie</h3>
<p>This is a SessionCookie used to maintain the login session between the ConsentAuthorisationUI and the ConsentAuthorisationApi. As this maintains the login state of the PSU in the ConsentAuthorisationUI, this session can be kept open for the life span of the interaction between the ConsentAuthorisationUI and the ConsentAuthorisationApi.</p>
<p>There is a X-XSRF-TOKEN String associated with the ConsentAuthSessionCookie. This information must be presented whenever the ConsentAuthorisationApi consumes the ConsentAuthSessionCookie. The X-XSRF-TOKEN encodes a key that is used to validate (evtl. encrypt/decrypt) information stored in the corresponding ConsentAuthSessionCookie.</p>
<h3 id="redirectsession"><a name="RedirectSession"></a> RedirectSession</h3>
<p>Holds consent information for the duration of a redirect. Redirect patterns are described <a href="./#Redirection">below</a>.</p>
<h3 id="redirectsessionstoreapi"><a name="RedirectSessionStoreApi"></a> RedirectSessionStoreApi</h3>
<p>Storage of temporary redirect sessions. Redirect session are stored only for the duration of the redirect request while redirecting from:
* FinTechApi to ConsentAuthorisationApi and validate when redirected back to secure coherance between FinTech and TPP identities.<br />
* ConsentAuthorisationApi to the OnlineBankingApi and validate when redirected back to secure coherance between TPP and ASPSP identities.</p>
<p>Consent Data might contain security sensitive data like account number or payment information of the PSU. This is the reason why they will be encrypted prior to being temporarily held for the duration of the redirection in the RedirectSessionStoreApi. So the RedirectSessionStoreApi will generate a temporary authorization code that contains both the id of the redirect session and the key used to encrypt the content of the redirect session.</p>
<p>Upon request, the RedirectSessionStoreApi will use the provided redirectCode to read and decrypt the consent session and will delete the consent session prior to returning it for the first time to the caller.</p>
<h3 id="bankingprotocol"><a name="BankingProtocol"></a> BankingProtocol</h3>
<p>Component managing access to a banking interfaces. We will have to deal with many protocols like NextGenPSD2, HBCI, OpenBanking UK, PolishAPI. For design details, see <a href="../drafts/initial_requirements/">BankingProtocol</a></p>
<h2 id="aspsp-data-center"><a name="AspspDC"></a> Aspsp Data Center</h2>
<p>Data center environment of the ASPSP</p>
<h3 id="aspspbankingapi"><a name="AspspBankingApi"></a> AspspBankingApi</h3>
<p>Api banking provided by ASPSP. This interface is not directly accessed by the PSU but by the TppBankingApi. TppBankingApi will use a TppContext to authenticate with the TppBankingApi.</p>
<h3 id="tppcontext"><a name="TppContext"></a> TppContext</h3>
<p>Information used to identify the Tpp application in the ASPSP environment. Like a TPP QWAC certificate.</p>
<h3 id="tppconsentsession"><a name="TppConsentSession"></a> TppConsentSession</h3>
<p>Storage for consent data in the realm of the TPP accessible to both the TppBankingApi and the ConsentAuthorizationApi.</p>
<p>The cryptographic key needed to recover the TppConsentSession is always delivered by the calling layer. These are:
- FinTechUI -&gt; FinTechApi -&gt; TppBankingApi : in this case the key needed to recover the TppConsentSession in contained in the PsuConsentSession. Generally that key will transitively originate from an interaction with the user agent. 
- CosentAuthorizationUI -&gt; CosentAuthorizationApi : in this case the key needed to recover the TppConsentSession originate from the ConsentAuthSessionCookie.</p>
<p>Beside consent data, additional data might be held in the TppConsentSession: 
- <a href="./#FinTechContext">FinTechContext</a>: Data needed to authorize the FinTechApi (FinTechSSLCertificate, ApiKey, SignedJWT)
- Additional information needed for interaction between TPP and ASPSP but without any concern to the PSU.</p>
<h3 id="onlinebankingapi"><a name="OnlineBankingApi"></a> OnlineBankingApi</h3>
<p>Generally the online banking application on an ASPSP. In redirect cases, the ASPSP OnlineBankingApi establishes a direct session with the PSU to allow the PSU to identify himself, review and authorize the consent. </p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/adorsys/open-banking-gateway/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>

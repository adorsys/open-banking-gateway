<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4032px" preserveAspectRatio="none" style="width:3421px;height:4032px;" version="1.1" viewBox="0 0 3421 4032" width="3421px" zoomAndPan="magnify"><defs><filter height="300%" id="f149jbbvmvrp2p" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="3925.1953" style="stroke: #A80036; stroke-width: 1.0;" width="617" x="638" y="96.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="57" x="918" y="108.2544">TPP API</text><rect fill="#DDDDDD" height="3925.1953" style="stroke: #A80036; stroke-width: 1.0;" width="833" x="1257" y="96.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="1623.5" y="108.2544">OPBA-Facade</text><rect fill="#DDDDDD" height="3925.1953" style="stroke: #A80036; stroke-width: 1.0;" width="1255" x="2092" y="96.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="2667.5" y="108.2544">XS2A-Protocol</text><rect fill="#FFFFFF" filter="url(#f149jbbvmvrp2p)" height="440.125" style="stroke: #000000; stroke-width: 2.0;" width="2828.5" x="214.5" y="1256.2656"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="38" x2="38" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="243.5" x2="243.5" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="531.5" x2="531.5" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="740" x2="740" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="940" x2="940" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1155" x2="1155" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1322" x2="1322" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1429" x2="1429" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1575" x2="1575" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1766" x2="1766" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1873" x2="1873" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2000" x2="2000" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2201" x2="2201" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2412" x2="2412" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2613" x2="2613" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2813" x2="2813" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2976" x2="2976" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3276" x2="3276" y1="178.4844" y2="3935.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3378" x2="3378" y1="178.4844" y2="3935.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="8" y="175.1826">FinTech</text><ellipse cx="38.5" cy="105.1875" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M38.5,113.1875 L38.5,140.1875 M25.5,121.1875 L51.5,121.1875 M38.5,140.1875 L25.5,155.1875 M38.5,140.1875 L51.5,155.1875 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="8" y="3947.0811">FinTech</text><ellipse cx="38.5" cy="3960.3828" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M38.5,3968.3828 L38.5,3995.3828 M25.5,3976.3828 L51.5,3976.3828 M38.5,3995.3828 L25.5,4010.3828 M38.5,3995.3828 L51.5,4010.3828 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="224.5" y="175.1826">User</text><ellipse cx="243.5" cy="105.1875" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M243.5,113.1875 L243.5,140.1875 M230.5,121.1875 L256.5,121.1875 M243.5,140.1875 L230.5,155.1875 M243.5,140.1875 L256.5,155.1875 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="224.5" y="3947.0811">User</text><ellipse cx="243.5" cy="3960.3828" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M243.5,3968.3828 L243.5,3995.3828 M230.5,3976.3828 L256.5,3976.3828 M243.5,3995.3828 L230.5,4010.3828 M243.5,3995.3828 L256.5,4010.3828 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="480.5" y="139.1875"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="476.5" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="483.5" y="163.1826">TppBackend</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="480.5" y="3934.0859"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="476.5" y="3938.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="483.5" y="3958.0811">TppBackend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="642" y="175.1826">TppBankingApiAisController</text><ellipse cx="740.5" cy="146.1875" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="736.5,134.1875,742.5,129.1875,740.5,134.1875,742.5,139.1875,736.5,134.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="642" y="3947.0811">TppBankingApiAisController</text><ellipse cx="740.5" cy="3966.3828" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="736.5,3954.3828,742.5,3949.3828,740.5,3954.3828,742.5,3959.3828,736.5,3954.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="176" x="849" y="175.1826">ConsentServiceController</text><ellipse cx="940" cy="146.1875" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="936,134.1875,942,129.1875,940,134.1875,942,139.1875,936,134.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="176" x="849" y="3947.0811">ConsentServiceController</text><ellipse cx="940" cy="3966.3828" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="936,3954.3828,942,3949.3828,940,3954.3828,942,3959.3828,936,3954.3828" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1060" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1067" y="163.1826">FacadeResponseMapper</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1060" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1067" y="3954.0811">FacadeResponseMapper</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1265" y="139.1875"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1261" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1268" y="163.1826">FacadeService</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1265" y="3934.0859"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1261" y="3938.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1268" y="3958.0811">FacadeService</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1393" y="175.1826">Database</text><path d="M1411,126.1875 C1411,116.1875 1429,116.1875 1429,116.1875 C1429,116.1875 1447,116.1875 1447,126.1875 L1447,152.1875 C1447,162.1875 1429,162.1875 1429,162.1875 C1429,162.1875 1411,162.1875 1411,152.1875 L1411,126.1875 " fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1411,126.1875 C1411,136.1875 1429,136.1875 1429,136.1875 C1429,136.1875 1447,136.1875 1447,126.1875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1393" y="3947.0811">Database</text><path d="M1411,3960.3828 C1411,3950.3828 1429,3950.3828 1429,3950.3828 C1429,3950.3828 1447,3950.3828 1447,3960.3828 L1447,3986.3828 C1447,3996.3828 1429,3996.3828 1429,3996.3828 C1429,3996.3828 1411,3996.3828 1411,3986.3828 L1411,3960.3828 " fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1411,3960.3828 C1411,3970.3828 1429,3970.3828 1429,3970.3828 C1429,3970.3828 1447,3970.3828 1447,3960.3828 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="1486" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="1493" y="163.1826">ServiceContextProvider</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="1486" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="1493" y="3954.0811">ServiceContextProvider</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1700" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1707" y="163.1826">ProtocolSelector</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1700" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1707" y="3954.0811">ProtocolSelector</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="1842" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1849" y="163.1826">Spring</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="1842" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1849" y="3954.0811">Spring</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="1914" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1921" y="163.1826">ProtocolResultHandler</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="1914" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1921" y="3954.0811">ProtocolResultHandler</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="2096" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="2103" y="163.1826">Xs2aListAccountsEntrypoint</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="2096" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="2103" y="3954.0811">Xs2aListAccountsEntrypoint</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="2316" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="2323" y="163.1826">Xs2aUpdateAuthorization</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="2316" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="2323" y="3954.0811">Xs2aUpdateAuthorization</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="184" x="2519" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="170" x="2526" y="163.1826">Xs2aFromAspspRedirect</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="184" x="2519" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="170" x="2526" y="3954.0811">Xs2aFromAspspRedirect</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="2717" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="2724" y="163.1826">Xs2aResultBodyExtractor</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="2717" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="2724" y="3954.0811">Xs2aResultBodyExtractor</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2923" y="139.1875"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2919" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="2926" y="163.1826">Xs2aServices</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2923" y="3934.0859"/><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2919" y="3938.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="2926" y="3958.0811">Xs2aServices</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="3209" y="143.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="3216" y="163.1826">OutcomeMapper</text><rect fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="3209" y="3934.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="3216" y="3954.0811">OutcomeMapper</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="3353" y="175.1826">ASPSP</text><path d="M3358,134.1875 L3358,158.1875 M3358,146.1875 L3375,146.1875 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3387" cy="146.1875" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="3353" y="3947.0811">ASPSP</text><path d="M3358,3954.3828 L3358,3978.3828 M3358,3966.3828 L3375,3966.3828 " fill="none" filter="url(#f149jbbvmvrp2p)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3387" cy="3966.3828" fill="#FEFECE" filter="url(#f149jbbvmvrp2p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="209.0508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="209.0508" y2="209.0508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="212.0508" y2="212.0508"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="267" x="1572.5" y="198.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="1578.5" y="214.5513">FinTech asks for user account list</text><polygon fill="#0000FF" points="519.5,263.8828,529.5,267.8828,519.5,271.8828,523.5,267.8828" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="38.5" x2="525.5" y1="267.8828" y2="267.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="45.5" y="247.6841">GET /accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="45.5" y="262.8169">(Fintech user info, bank id, etc.)</text><polygon fill="#0000FF" points="728.5,293.0156,738.5,297.0156,728.5,301.0156,732.5,297.0156" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="531.5" x2="734.5" y1="297.0156" y2="297.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="538.5" y="291.9497">getAccounts</text><polygon fill="#0000FF" points="1310,322.1484,1320,326.1484,1310,330.1484,1314,326.1484" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="740.5" x2="1316" y1="326.1484" y2="326.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="747.5" y="321.0825">Facade.execute()</text><polygon fill="#0000FF" points="1563,351.2813,1573,355.2813,1563,359.2813,1567,355.2813" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1322" x2="1569" y1="355.2813" y2="355.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1329" y="350.2153">Create facade context from request</text><polygon fill="#0000FF" points="1333,380.4141,1323,384.4141,1333,388.4141,1329,384.4141" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1327" x2="1574" y1="384.4141" y2="384.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1339" y="379.3481">ServiceContext</text><polygon fill="#0000FF" points="1754,409.5469,1764,413.5469,1754,417.5469,1758,413.5469" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1322" x2="1760" y1="413.5469" y2="413.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="1329" y="408.481">Select bank protocol from request type and bank id</text><polygon fill="#0000FF" points="1440,438.6797,1430,442.6797,1440,446.6797,1436,442.6797" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1434" x2="1765" y1="442.6797" y2="442.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="1446" y="437.6138">Read bank protocol using bank uuid and action id</text><polygon fill="#0000FF" points="1754,467.8125,1764,471.8125,1754,475.8125,1758,471.8125" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1429" x2="1760" y1="471.8125" y2="471.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1436" y="466.7466">BankProtocol</text><polygon fill="#0000FF" points="1333,496.9453,1323,500.9453,1333,504.9453,1329,500.9453" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1327" x2="1765" y1="500.9453" y2="500.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1339" y="495.8794">BankProtocol</text><polygon fill="#0000FF" points="1861,526.0781,1871,530.0781,1861,534.0781,1865,530.0781" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1322" x2="1867" y1="530.0781" y2="530.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1329" y="525.0122">Find bean - Bean(BankProtocol.protocolBeanName) extends Action</text><polygon fill="#0000FF" points="1333,555.2109,1323,559.2109,1333,563.2109,1329,559.2109" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1327" x2="1872" y1="559.2109" y2="559.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="1339" y="554.145">It is Xs2aListAccountsEntrypoint service bean</text><polygon fill="#0000FF" points="2189,584.3438,2199,588.3438,2189,592.3438,2193,588.3438" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1322" x2="2195" y1="588.3438" y2="588.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="1329" y="583.2778">Xs2aListAccountsEntrypoint.execute(ServiceContext)</text><polygon fill="#0000FF" points="2964,598.3438,2974,602.3438,2964,606.3438,2968,602.3438" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2201" x2="2970" y1="602.3438" y2="602.3438"/><polygon fill="#0000FF" points="1440,627.4766,1430,631.4766,1440,635.4766,1436,631.4766" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1434" x2="2975" y1="631.4766" y2="631.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1446" y="626.4106">Consent for service session</text><polygon fill="#0000FF" points="2964,656.6094,2974,660.6094,2964,664.6094,2968,660.6094" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1429" x2="2970" y1="660.6094" y2="660.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="1436" y="655.5435">No consent</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2976" x2="3018" y1="704.875" y2="704.875"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="3018" x2="3018" y1="704.875" y2="717.875"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2977" x2="3018" y1="717.875" y2="717.875"/><polygon fill="#0000FF" points="2987,713.875,2977,717.875,2987,721.875,2983,717.875" style="stroke: #0000FF; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="2983" y="684.6763">Validate API input -</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="2983" y="699.8091">do we have enough data (Mocked execution)</text><polygon fill="#0000FF" points="2212,743.0078,2202,747.0078,2212,751.0078,2208,747.0078" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2206" x2="2975" y1="747.0078" y2="747.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="2218" y="741.9419">ValidationIssue[] -&gt; User input has missing parameters</text><polygon fill="#0000FF" points="3264,772.1406,3274,776.1406,3264,780.1406,3268,776.1406" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2201" x2="3270" y1="776.1406" y2="776.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="2208" y="771.0747">Translate ValidationIssue[]</text><polygon fill="#0000FF" points="2212,801.2734,2202,805.2734,2212,809.2734,2208,805.2734" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="2206" x2="3275" y1="805.2734" y2="805.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="2218" y="800.2075">ContextBasedValidationErrorResult</text><polygon fill="#0000FF" points="1333,830.4063,1323,834.4063,1333,838.4063,1329,834.4063" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1327" x2="2200" y1="834.4063" y2="834.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1339" y="829.3403">ContextBasedValidationErrorResult</text><polygon fill="#0000FF" points="1988,859.5391,1998,863.5391,1988,867.5391,1992,863.5391" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1322" x2="1994" y1="863.5391" y2="863.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="1329" y="858.4731">Translate ContextBasedValidationErrorResult -&gt; FacadeStartAuthorizationResult</text><polygon fill="#0000FF" points="1440,888.6719,1430,892.6719,1440,896.6719,1436,892.6719" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1434" x2="1999" y1="892.6719" y2="892.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1446" y="887.606">Authorization session present?</text><polygon fill="#0000FF" points="1988,917.8047,1998,921.8047,1988,925.8047,1992,921.8047" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1429" x2="1994" y1="921.8047" y2="921.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1436" y="916.7388">No authorization session</text><polygon fill="#0000FF" points="1440,946.9375,1430,950.9375,1440,954.9375,1436,950.9375" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1434" x2="1999" y1="950.9375" y2="950.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1446" y="945.8716">Create authorization session</text><polygon fill="#0000FF" points="751.5,976.0703,741.5,980.0703,751.5,984.0703,747.5,980.0703" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="745.5" x2="1999" y1="980.0703" y2="980.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="757.5" y="975.0044">process FacadeStartAuthorizationResult</text><polygon fill="#0000FF" points="1143.5,1005.2031,1153.5,1009.2031,1143.5,1013.2031,1147.5,1009.2031" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="740.5" x2="1149.5" y1="1009.2031" y2="1009.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="747.5" y="1004.1372">translate FacadeStartAuthorizationResult</text><polygon fill="#0000FF" points="751.5,1034.3359,741.5,1038.3359,751.5,1042.3359,747.5,1038.3359" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="745.5" x2="1154.5" y1="1038.3359" y2="1038.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="757.5" y="1033.27">This is 202 code with redirection to Embedded authorization</text><polygon fill="#0000FF" points="542.5,1063.4688,532.5,1067.4688,542.5,1071.4688,538.5,1067.4688" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="536.5" x2="739.5" y1="1067.4688" y2="1067.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="548.5" y="1062.4028">202 Embedded authorization</text><polygon fill="#0000FF" points="49.5,1092.6016,39.5,1096.6016,49.5,1100.6016,45.5,1096.6016" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="43.5" x2="530.5" y1="1096.6016" y2="1096.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="55.5" y="1091.5356">202 Embedded authorization</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="38.5" x2="80.5" y1="1125.7344" y2="1125.7344"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="80.5" x2="80.5" y1="1125.7344" y2="1138.7344"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="39.5" x2="80.5" y1="1138.7344" y2="1138.7344"/><polygon fill="#0000FF" points="49.5,1134.7344,39.5,1138.7344,49.5,1142.7344,45.5,1138.7344" style="stroke: #0000FF; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="45.5" y="1120.6685">Store</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="84.5" y="1120.6685">service session id</text><polygon fill="#FFA500" points="231.5,1194.1328,241.5,1198.1328,231.5,1202.1328,235.5,1198.1328" style="stroke: #FFA500; stroke-width: 1.0;"/><line style="stroke: #FFA500; stroke-width: 1.0;" x1="38.5" x2="237.5" y1="1198.1328" y2="1198.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="45.5" y="1162.8013">Redirect user to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="45.5" y="1177.9341">'Embedded authorization'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="45.5" y="1193.0669">form using 'Location' header</text><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="1226.6992"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="1226.6992" y2="1226.6992"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="1229.6992" y2="1229.6992"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="488" x="1462" y="1216.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="469" x="1468" y="1232.1997">User authorizes this request (embedded to provide i.e. PSU id)</text><path d="M214.5,1256.2656 L291.5,1256.2656 L291.5,1263.2656 L281.5,1273.2656 L214.5,1273.2656 L214.5,1256.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="440.125" style="stroke: #000000; stroke-width: 2.0;" width="2828.5" x="214.5" y="1256.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="229.5" y="1269.3325">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="306.5" y="1268.4761">[Until user input has not enough parameters]</text><polygon fill="#008000" points="519.5,1305.6641,529.5,1309.6641,519.5,1313.6641,523.5,1309.6641" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="243.5" x2="525.5" y1="1309.6641" y2="1309.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="250.5" y="1289.4653">POST /consent/embedded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="250.5" y="1304.5981">(Consent valid until, which accounts, etc.)</text><polygon fill="#008000" points="928,1334.7969,938,1338.7969,928,1342.7969,932,1338.7969" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="531.5" x2="934" y1="1338.7969" y2="1338.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="538.5" y="1333.731">embeddedUsingPOST</text><polygon fill="#008000" points="1310,1363.9297,1320,1367.9297,1310,1371.9297,1314,1367.9297" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="940" x2="1316" y1="1367.9297" y2="1367.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="947" y="1362.8638">Facade.execute()</text><polygon fill="#008000" points="1563,1393.0625,1573,1397.0625,1563,1401.0625,1567,1397.0625" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1322" x2="1569" y1="1397.0625" y2="1397.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1329" y="1391.9966">Create facade context from request</text><polygon fill="#008000" points="1333,1422.1953,1323,1426.1953,1333,1430.1953,1329,1426.1953" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1327" x2="1574" y1="1426.1953" y2="1426.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1339" y="1421.1294">ServiceContext</text><polygon fill="#008000" points="1754,1451.3281,1764,1455.3281,1754,1459.3281,1758,1455.3281" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1322" x2="1760" y1="1455.3281" y2="1455.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1329" y="1450.2622">Select bank protocol by using authorization session id</text><polygon fill="#008000" points="1440,1480.4609,1430,1484.4609,1440,1488.4609,1436,1484.4609" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1434" x2="1765" y1="1484.4609" y2="1484.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="1446" y="1479.395">Read authorization session</text><polygon fill="#008000" points="1754,1509.5938,1764,1513.5938,1754,1517.5938,1758,1513.5938" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1429" x2="1760" y1="1513.5938" y2="1513.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1436" y="1508.5278">Bank protocol id from authorization session</text><polygon fill="#008000" points="1440,1538.7266,1430,1542.7266,1440,1546.7266,1436,1542.7266" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1434" x2="1765" y1="1542.7266" y2="1542.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1446" y="1537.6606">Read bank protocol using its id</text><polygon fill="#008000" points="1754,1567.8594,1764,1571.8594,1754,1575.8594,1758,1571.8594" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1429" x2="1760" y1="1571.8594" y2="1571.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1436" y="1566.7935">BankProtocol</text><polygon fill="#008000" points="1333,1596.9922,1323,1600.9922,1333,1604.9922,1329,1600.9922" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1327" x2="1765" y1="1600.9922" y2="1600.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1339" y="1595.9263">BankProtocol</text><polygon fill="#008000" points="1861,1626.125,1871,1630.125,1861,1634.125,1865,1630.125" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1322" x2="1867" y1="1630.125" y2="1630.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1329" y="1625.0591">Find bean - Bean(BankProtocol.protocolBeanName) extends Action</text><polygon fill="#008000" points="1333,1655.2578,1323,1659.2578,1333,1663.2578,1329,1659.2578" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1327" x2="1872" y1="1659.2578" y2="1659.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="1339" y="1654.1919">It is Xs2aUpdateAuthorization service bean</text><polygon fill="#008000" points="2964,1684.3906,2974,1688.3906,2964,1692.3906,2968,1688.3906" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2412.5" x2="2970" y1="1688.3906" y2="1688.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="2419.5" y="1683.3247">Update context with users' input</text><line style="stroke: #008000; stroke-width: 1.0;" x1="2976" x2="3018" y1="1724.5234" y2="1724.5234"/><line style="stroke: #008000; stroke-width: 1.0;" x1="3018" x2="3018" y1="1724.5234" y2="1737.5234"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2977" x2="3018" y1="1737.5234" y2="1737.5234"/><polygon fill="#008000" points="2987,1733.5234,2977,1737.5234,2987,1741.5234,2983,1737.5234" style="stroke: #008000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="2983" y="1719.4575">User input OK</text><line style="stroke: #008000; stroke-width: 1.0;" x1="2976" x2="3018" y1="1766.6563" y2="1766.6563"/><line style="stroke: #008000; stroke-width: 1.0;" x1="3018" x2="3018" y1="1766.6563" y2="1779.6563"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2977" x2="3018" y1="1779.6563" y2="1779.6563"/><polygon fill="#008000" points="2987,1775.6563,2977,1779.6563,2987,1783.6563,2983,1779.6563" style="stroke: #008000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="2983" y="1761.5903">Switch to real execution mode</text><polygon fill="#008000" points="3366.5,1804.7891,3376.5,1808.7891,3366.5,1812.7891,3370.5,1808.7891" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2976" x2="3372.5" y1="1808.7891" y2="1808.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2983" y="1803.7231">Initiate consent</text><polygon fill="#008000" points="2987,1833.9219,2977,1837.9219,2987,1841.9219,2983,1837.9219" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2981" x2="3377.5" y1="1837.9219" y2="1837.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="2993" y="1832.856">Redirect authorization required</text><polygon fill="#008000" points="2212,1863.0547,2202,1867.0547,2212,1871.0547,2208,1867.0547" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2206" x2="2975" y1="1867.0547" y2="1867.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="2218" y="1861.9888">Redirect to ASPSP required</text><polygon fill="#008000" points="3264,1892.1875,3274,1896.1875,3264,1900.1875,3268,1896.1875" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2201" x2="3270" y1="1896.1875" y2="1896.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="2208" y="1891.1216">Translate 'Redirect to ASPSP required'</text><polygon fill="#008000" points="2212,1921.3203,2202,1925.3203,2212,1929.3203,2208,1925.3203" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2206" x2="3275" y1="1925.3203" y2="1925.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="2218" y="1920.2544">ContextBasedAuthorizationRequiredResult</text><polygon fill="#008000" points="1333,1950.4531,1323,1954.4531,1333,1958.4531,1329,1954.4531" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1327" x2="2200" y1="1954.4531" y2="1954.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1339" y="1949.3872">ContextBasedAuthorizationRequiredResult</text><polygon fill="#008000" points="1988,1979.5859,1998,1983.5859,1988,1987.5859,1992,1983.5859" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1322" x2="1994" y1="1983.5859" y2="1983.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1329" y="1978.52">Translate FacadeStartAuthorizationResult -&gt; FacadeRedirectResult</text><polygon fill="#008000" points="1143.5,2008.7188,1153.5,2012.7188,1143.5,2016.7188,1147.5,2012.7188" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="740.5" x2="1149.5" y1="2012.7188" y2="2012.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="747.5" y="2007.6528">translate FacadeRedirectResult</text><polygon fill="#008000" points="751.5,2037.8516,741.5,2041.8516,751.5,2045.8516,747.5,2041.8516" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="745.5" x2="1154.5" y1="2041.8516" y2="2041.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="757.5" y="2036.7856">This is 303 code with redirection to ASPSP authorization page</text><polygon fill="#008000" points="542.5,2066.9844,532.5,2070.9844,542.5,2074.9844,538.5,2070.9844" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="536.5" x2="739.5" y1="2070.9844" y2="2070.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="548.5" y="2065.9185">303 Redirect to ASPSP</text><polygon fill="#008000" points="254.5,2096.1172,244.5,2100.1172,254.5,2104.1172,250.5,2100.1172" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="248.5" x2="530.5" y1="2100.1172" y2="2100.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="260.5" y="2095.0513">303 ASPSP 'Login page'</text><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="2128.6836"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2128.6836" y2="2128.6836"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2131.6836" y2="2131.6836"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="392" x="1510" y="2118.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="1516" y="2134.1841">User authorizes this request with ASPSP (redirect)</text><polygon fill="#FFA500" points="3366.5,2168.3828,3376.5,2172.3828,3366.5,2176.3828,3370.5,2172.3828" style="stroke: #FFA500; stroke-width: 1.0;"/><line style="stroke: #FFA500; stroke-width: 1.0;" x1="243.5" x2="3372.5" y1="2172.3828" y2="2172.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="250.5" y="2167.3169">Authorization</text><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="2200.9492"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2200.9492" y2="2200.9492"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2203.9492" y2="2203.9492"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="317" x="1547.5" y="2190.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="1553.5" y="2206.4497">ASPSP reports consent authorization OK</text><polygon fill="#FF00FF" points="254.5,2240.6484,244.5,2244.6484,254.5,2248.6484,250.5,2244.6484" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="248.5" x2="3377.5" y1="2244.6484" y2="2244.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="260.5" y="2239.5825">Done, optionally redirect</text><polygon fill="#FF00FF" points="542.5,2269.7813,532.5,2273.7813,542.5,2277.7813,538.5,2273.7813" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="536.5" x2="3377.5" y1="2273.7813" y2="2273.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="548.5" y="2268.7153">GET /from/aspsp/ok webhook</text><polygon fill="#FF00FF" points="928,2298.9141,938,2302.9141,928,2306.9141,932,2302.9141" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="531.5" x2="934" y1="2302.9141" y2="2302.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="538.5" y="2297.8481">fromAspspOkUsingGET</text><polygon fill="#FF00FF" points="1310,2328.0469,1320,2332.0469,1310,2336.0469,1314,2332.0469" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="940" x2="1316" y1="2332.0469" y2="2332.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="947" y="2326.981">Facade.execute()</text><polygon fill="#FF00FF" points="1563,2357.1797,1573,2361.1797,1563,2365.1797,1567,2361.1797" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1322" x2="1569" y1="2361.1797" y2="2361.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1329" y="2356.1138">Create facade context from request</text><polygon fill="#FF00FF" points="1333,2386.3125,1323,2390.3125,1333,2394.3125,1329,2390.3125" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1327" x2="1574" y1="2390.3125" y2="2390.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1339" y="2385.2466">ServiceContext</text><polygon fill="#FF00FF" points="1754,2415.4453,1764,2419.4453,1754,2423.4453,1758,2419.4453" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1322" x2="1760" y1="2419.4453" y2="2419.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1329" y="2414.3794">Select bank protocol by using authorization session id</text><polygon fill="#FF00FF" points="1440,2444.5781,1430,2448.5781,1440,2452.5781,1436,2448.5781" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1434" x2="1765" y1="2448.5781" y2="2448.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="1446" y="2443.5122">Read authorization session</text><polygon fill="#FF00FF" points="1754,2473.7109,1764,2477.7109,1754,2481.7109,1758,2477.7109" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1429" x2="1760" y1="2477.7109" y2="2477.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1436" y="2472.645">Bank protocol id from authorization session</text><polygon fill="#FF00FF" points="1440,2502.8438,1430,2506.8438,1440,2510.8438,1436,2506.8438" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1434" x2="1765" y1="2506.8438" y2="2506.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1446" y="2501.7778">Read bank protocol using its id</text><polygon fill="#FF00FF" points="1754,2531.9766,1764,2535.9766,1754,2539.9766,1758,2535.9766" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1429" x2="1760" y1="2535.9766" y2="2535.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1436" y="2530.9106">BankProtocol</text><polygon fill="#FF00FF" points="1333,2561.1094,1323,2565.1094,1333,2569.1094,1329,2565.1094" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1327" x2="1765" y1="2565.1094" y2="2565.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1339" y="2560.0435">BankProtocol</text><polygon fill="#FF00FF" points="1861,2590.2422,1871,2594.2422,1861,2598.2422,1865,2594.2422" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1322" x2="1867" y1="2594.2422" y2="2594.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1329" y="2589.1763">Find bean - Bean(BankProtocol.protocolBeanName) extends Action</text><polygon fill="#FF00FF" points="1333,2619.375,1323,2623.375,1333,2627.375,1329,2623.375" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1327" x2="1872" y1="2623.375" y2="2623.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="1339" y="2618.3091">It is Xs2aFromAspspRedirect service bean</text><polygon fill="#FF00FF" points="2964,2648.5078,2974,2652.5078,2964,2656.5078,2968,2652.5078" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="2613" x2="2970" y1="2652.5078" y2="2652.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="2620" y="2647.4419">Bank approved consent</text><polygon fill="#FF00FF" points="1440,2677.6406,1430,2681.6406,1440,2685.6406,1436,2681.6406" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1434" x2="2975" y1="2681.6406" y2="2681.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1446" y="2676.5747">Persist consent and its context</text><polygon fill="#FF00FF" points="2624,2706.7734,2614,2710.7734,2624,2714.7734,2620,2710.7734" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="2618" x2="2975" y1="2710.7734" y2="2710.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="2630" y="2705.7075">Consent acquired</text><polygon fill="#FF00FF" points="3264,2735.9063,3274,2739.9063,3264,2743.9063,3268,2739.9063" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="2613" x2="3270" y1="2739.9063" y2="2739.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="2620" y="2734.8403">Translate 'Consent acquired'</text><polygon fill="#FF00FF" points="2624,2765.0391,2614,2769.0391,2624,2773.0391,2620,2769.0391" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="2618" x2="3275" y1="2769.0391" y2="2769.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="2630" y="2763.9731">ConsentAcquiredResult</text><polygon fill="#FF00FF" points="1333,2794.1719,1323,2798.1719,1333,2802.1719,1329,2798.1719" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1327" x2="2612" y1="2798.1719" y2="2798.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1339" y="2793.106">ConsentAcquiredResult</text><polygon fill="#FF00FF" points="1988,2823.3047,1998,2827.3047,1988,2831.3047,1992,2827.3047" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="1322" x2="1994" y1="2827.3047" y2="2827.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="372" x="1329" y="2822.2388">Translate ConsentAcquiredResult -&gt; FacadeRedirectResult</text><polygon fill="#FF00FF" points="1143.5,2852.4375,1153.5,2856.4375,1143.5,2860.4375,1147.5,2856.4375" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="740.5" x2="1149.5" y1="2856.4375" y2="2856.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="747.5" y="2851.3716">translate FacadeRedirectResult</text><polygon fill="#FF00FF" points="751.5,2881.5703,741.5,2885.5703,751.5,2889.5703,747.5,2885.5703" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="745.5" x2="1154.5" y1="2885.5703" y2="2885.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="757.5" y="2880.5044">This is 303 code with redirection to FinTech</text><polygon fill="#FF00FF" points="542.5,2910.7031,532.5,2914.7031,542.5,2918.7031,538.5,2914.7031" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="536.5" x2="739.5" y1="2914.7031" y2="2914.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="548.5" y="2909.6372">303 Redirect to FinTech</text><polygon fill="#FF00FF" points="254.5,2939.8359,244.5,2943.8359,254.5,2947.8359,250.5,2943.8359" style="stroke: #FF00FF; stroke-width: 1.0;"/><line style="stroke: #FF00FF; stroke-width: 1.0;" x1="248.5" x2="530.5" y1="2943.8359" y2="2943.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="260.5" y="2938.77">303 FinTech 'Thanks for consent' page</text><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="2972.4023"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2972.4023" y2="2972.4023"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="2975.4023" y2="2975.4023"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="410" x="1501" y="2961.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="391" x="1507" y="2977.9028">Fintech receives notification that consent is received</text><polygon fill="#FFA500" points="49.5,2996.9688,39.5,3000.9688,49.5,3004.9688,45.5,3000.9688" style="stroke: #FFA500; stroke-width: 1.0;"/><line style="stroke: #FFA500; stroke-width: 1.0;" x1="43.5" x2="242.5" y1="3000.9688" y2="3000.9688"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3406" x="3" y="3029.5352"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="3029.5352" y2="3029.5352"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3409" y1="3032.5352" y2="3032.5352"/><rect fill="#EEEEEE" filter="url(#f149jbbvmvrp2p)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="411" x="1500.5" y="3018.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="392" x="1506.5" y="3035.0356">Fintech calls user account list within same session id</text><polygon fill="#A80036" points="519.5,3084.3672,529.5,3088.3672,519.5,3092.3672,523.5,3088.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="38.5" x2="525.5" y1="3088.3672" y2="3088.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="45.5" y="3068.1685">GET /accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="49.5" y="3083.3013">with</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="78.5" y="3083.3013">service session id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="213.5" y="3083.3013">and Fintech user info, bank id, etc.</text><polygon fill="#A80036" points="728.5,3113.5,738.5,3117.5,728.5,3121.5,732.5,3117.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="531.5" x2="734.5" y1="3117.5" y2="3117.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="538.5" y="3112.4341">getAccounts</text><polygon fill="#A80036" points="1310,3142.6328,1320,3146.6328,1310,3150.6328,1314,3146.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="740.5" x2="1316" y1="3146.6328" y2="3146.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="747.5" y="3141.5669">Facade.execute()</text><polygon fill="#A80036" points="1563,3171.7656,1573,3175.7656,1563,3179.7656,1567,3175.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322" x2="1569" y1="3175.7656" y2="3175.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1329" y="3170.6997">Create facade context from request</text><polygon fill="#A80036" points="1333,3200.8984,1323,3204.8984,1333,3208.8984,1329,3204.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1574" y1="3204.8984" y2="3204.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1339" y="3199.8325">ServiceContext</text><polygon fill="#A80036" points="1754,3230.0313,1764,3234.0313,1754,3238.0313,1758,3234.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322" x2="1760" y1="3234.0313" y2="3234.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="1329" y="3228.9653">Select bank protocol from request type and bank id</text><polygon fill="#A80036" points="1440,3259.1641,1430,3263.1641,1440,3267.1641,1436,3263.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1434" x2="1765" y1="3263.1641" y2="3263.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="1446" y="3258.0981">Read bank protocol using bank uuid and action id</text><polygon fill="#A80036" points="1754,3288.2969,1764,3292.2969,1754,3296.2969,1758,3292.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1429" x2="1760" y1="3292.2969" y2="3292.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1436" y="3287.231">BankProtocol</text><polygon fill="#A80036" points="1333,3317.4297,1323,3321.4297,1333,3325.4297,1329,3321.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1765" y1="3321.4297" y2="3321.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1339" y="3316.3638">BankProtocol</text><polygon fill="#A80036" points="1861,3346.5625,1871,3350.5625,1861,3354.5625,1865,3350.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322" x2="1867" y1="3350.5625" y2="3350.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1329" y="3345.4966">Find bean - Bean(BankProtocol.protocolBeanName) extends Action</text><polygon fill="#A80036" points="1333,3375.6953,1323,3379.6953,1333,3383.6953,1329,3379.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1872" y1="3379.6953" y2="3379.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="1339" y="3374.6294">It is Xs2aListAccountsEntrypoint service bean</text><polygon fill="#A80036" points="2189,3404.8281,2199,3408.8281,2189,3412.8281,2193,3408.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322" x2="2195" y1="3408.8281" y2="3408.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="1329" y="3403.7622">Xs2aListAccountsEntrypoint.execute(ServiceContext)</text><polygon fill="#A80036" points="1440,3433.9609,1430,3437.9609,1440,3441.9609,1436,3437.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1434" x2="2200" y1="3437.9609" y2="3437.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1446" y="3432.895">Consent for service session</text><polygon fill="#A80036" points="2189,3463.0938,2199,3467.0938,2189,3471.0938,2193,3467.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1429" x2="2195" y1="3467.0938" y2="3467.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1436" y="3462.0278">Consent present,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1550" y="3462.0278">consent context</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2976" x2="3018" y1="3511.3594" y2="3511.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3018" x2="3018" y1="3511.3594" y2="3524.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2977" x2="3018" y1="3524.3594" y2="3524.3594"/><polygon fill="#A80036" points="2987,3520.3594,2977,3524.3594,2987,3528.3594,2983,3524.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="2983" y="3491.1606">Validate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="3039" y="3491.1606">consent context</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="3161" y="3491.1606">-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="2983" y="3506.2935">do we have enough data (Mocked execution)</text><polygon fill="#A80036" points="3366.5,3549.4922,3376.5,3553.4922,3366.5,3557.4922,3370.5,3553.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2976" x2="3372.5" y1="3553.4922" y2="3553.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="2983" y="3548.4263">Call ASPSP with consent using</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="3179" y="3548.4263">consent context</text><polygon fill="#A80036" points="2987,3578.625,2977,3582.625,2987,3586.625,2983,3582.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2981" x2="3377.5" y1="3582.625" y2="3582.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="2993" y="3577.5591">Users' accounts</text><polygon fill="#A80036" points="3264,3607.7578,3274,3611.7578,3264,3615.7578,3268,3611.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2976" x2="3270" y1="3611.7578" y2="3611.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="2983" y="3606.6919">Translate ASPSP response</text><polygon fill="#A80036" points="2824,3636.8906,2814,3640.8906,2824,3644.8906,2820,3640.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2818" x2="3275" y1="3640.8906" y2="3640.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="2830" y="3635.8247">Translate ASPSP response</text><polygon fill="#A80036" points="3264,3666.0234,3274,3670.0234,3264,3674.0234,3268,3670.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2813" x2="3270" y1="3670.0234" y2="3670.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="2820" y="3664.9575">Account list</text><polygon fill="#A80036" points="2212,3680.0234,2202,3684.0234,2212,3688.0234,2208,3684.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2206" x2="3275" y1="3684.0234" y2="3684.0234"/><polygon fill="#A80036" points="1333,3709.1563,1323,3713.1563,1333,3717.1563,1329,3713.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="2200" y1="3713.1563" y2="3713.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="1339" y="3708.0903">SuccessResult&lt;Account list&gt;</text><polygon fill="#A80036" points="1333,3738.2891,1323,3742.2891,1333,3746.2891,1329,3742.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="2612" y1="3742.2891" y2="3742.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="1339" y="3737.2231">SuccessResult&lt;Account list&gt;</text><polygon fill="#A80036" points="1988,3767.4219,1998,3771.4219,1988,3775.4219,1992,3771.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322" x2="1994" y1="3771.4219" y2="3771.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="1329" y="3766.356">Translate SuccessResult -&gt; FacadeSuccessResult</text><polygon fill="#A80036" points="751.5,3796.5547,741.5,3800.5547,751.5,3804.5547,747.5,3800.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="745.5" x2="1999" y1="3800.5547" y2="3800.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="757.5" y="3795.4888">process FacadeSuccessResult</text><polygon fill="#A80036" points="1143.5,3825.6875,1153.5,3829.6875,1143.5,3833.6875,1147.5,3829.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="740.5" x2="1149.5" y1="3829.6875" y2="3829.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="747.5" y="3824.6216">translate FacadeSuccessResult</text><polygon fill="#A80036" points="751.5,3854.8203,741.5,3858.8203,751.5,3862.8203,747.5,3858.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="745.5" x2="1154.5" y1="3858.8203" y2="3858.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="757.5" y="3853.7544">This is 200 code with Account list body</text><polygon fill="#A80036" points="542.5,3883.9531,532.5,3887.9531,542.5,3891.9531,538.5,3887.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="536.5" x2="739.5" y1="3887.9531" y2="3887.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="548.5" y="3882.8872">200 and Account list</text><polygon fill="#A80036" points="49.5,3913.0859,39.5,3917.0859,49.5,3921.0859,45.5,3917.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43.5" x2="530.5" y1="3917.0859" y2="3917.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="55.5" y="3912.02">200 and Account list</text><rect fill="#DDDDDD" height="75.1875" rx="5" ry="5" style="stroke: #000000; stroke-width: 1.0;" width="299" x="11" y="11"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="17" y="28.9951">Combined</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="242" x="17" y="45.292">embedded (Extra user parameters)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="236" x="17" y="61.5889">and redirect (ASPSP authorization)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="17" y="77.8857">authorization when</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="157" y="77.8857">consent is missing</text><!--MD5=[075f519f52721939408b9a5ca271bc47]
@startuml
legend top left
  <b>Combined</b>
  embedded (Extra user parameters)
  and redirect (ASPSP authorization)
  authorization when  <b>consent is missing</b>
endlegend

actor FinTech
actor User

collections TppBackend

box "TPP API"
control TppBankingApiAisController
control ConsentServiceController
participant FacadeResponseMapper
endbox

box "OPBA-Facade"
collections FacadeService
database Database
participant ServiceContextProvider
participant ProtocolSelector
participant Spring
participant ProtocolResultHandler
endbox

box "XS2A-Protocol"
participant Xs2aListAccountsEntrypoint
participant Xs2aUpdateAuthorization
participant Xs2aFromAspspRedirect
participant Xs2aResultBodyExtractor
collections Xs2aServices
participant OutcomeMapper
endbox

boundary ASPSP

== FinTech asks for user account list ==
FinTech [#blue]-> TppBackend : GET /accounts\n(Fintech user info, bank id, etc.)
TppBackend [#blue]-> TppBankingApiAisController : getAccounts
TppBankingApiAisController [#blue]-> FacadeService : Facade.execute()
FacadeService [#blue]-> ServiceContextProvider : Create facade context from request
FacadeService <-[#blue] ServiceContextProvider : ServiceContext
FacadeService [#blue]-> ProtocolSelector : Select bank protocol from request type and bank id
ProtocolSelector [#blue]-> Database : Read bank protocol using bank uuid and action id
Database [#blue]-> ProtocolSelector : BankProtocol
ProtocolSelector [#blue]-> FacadeService : BankProtocol
FacadeService [#blue]-> Spring : Find bean - Bean(BankProtocol.protocolBeanName) extends Action
FacadeService <-[#blue] Spring : It is Xs2aListAccountsEntrypoint service bean
FacadeService [#blue]-> Xs2aListAccountsEntrypoint : Xs2aListAccountsEntrypoint.execute(ServiceContext)
Xs2aListAccountsEntrypoint [#blue]-> Xs2aServices
Xs2aServices [#blue]-> Database : Consent for service session
Xs2aServices <-[#blue] Database : No consent
Xs2aServices [#blue]-> Xs2aServices : Validate API input -\ndo we have enough data (Mocked execution)
Xs2aServices [#blue]-> Xs2aListAccountsEntrypoint : ValidationIssue[] -> User input has missing parameters
Xs2aListAccountsEntrypoint [#blue]-> OutcomeMapper : Translate ValidationIssue[]
OutcomeMapper [#blue]-> Xs2aListAccountsEntrypoint : ContextBasedValidationErrorResult
Xs2aListAccountsEntrypoint [#blue]-> FacadeService : ContextBasedValidationErrorResult
FacadeService [#blue]-> ProtocolResultHandler : Translate ContextBasedValidationErrorResult -> FacadeStartAuthorizationResult
ProtocolResultHandler [#blue]-> Database : Authorization session present?
Database [#blue]-> ProtocolResultHandler : No authorization session
ProtocolResultHandler [#blue]-> Database : Create authorization session
ProtocolResultHandler [#blue]-> TppBankingApiAisController : process FacadeStartAuthorizationResult
TppBankingApiAisController [#blue]-> FacadeResponseMapper : translate FacadeStartAuthorizationResult
FacadeResponseMapper [#blue]-> TppBankingApiAisController : This is 202 code with redirection to Embedded authorization
TppBankingApiAisController [#blue]-> TppBackend : 202 Embedded authorization
TppBackend [#blue]-> FinTech : 202 Embedded authorization
FinTech [#blue]-> FinTech : Store <b>service session id</b>

FinTech [#orange]-> User : Redirect user to\n'Embedded authorization'\nform using 'Location' header

== User authorizes this request (embedded to provide i.e. PSU id) ==
loop Until user input has not enough parameters
User [#green]-> TppBackend : POST /consent/embedded\n(Consent valid until, which accounts, etc.)
TppBackend [#green]-> ConsentServiceController : embeddedUsingPOST
ConsentServiceController [#green]-> FacadeService : Facade.execute()
FacadeService [#green]-> ServiceContextProvider : Create facade context from request
FacadeService <-[#green] ServiceContextProvider : ServiceContext
FacadeService [#green]-> ProtocolSelector : Select bank protocol by using authorization session id
ProtocolSelector [#green]-> Database : Read authorization session
Database [#green]-> ProtocolSelector: Bank protocol id from authorization session
ProtocolSelector [#green]-> Database : Read bank protocol using its id
Database [#green]-> ProtocolSelector : BankProtocol
ProtocolSelector [#green]-> FacadeService : BankProtocol
FacadeService [#green]-> Spring : Find bean - Bean(BankProtocol.protocolBeanName) extends Action
FacadeService <-[#green] Spring : It is Xs2aUpdateAuthorization service bean
Xs2aUpdateAuthorization [#green]-> Xs2aServices : Update context with users' input
end
Xs2aServices [#green]-> Xs2aServices : User input OK
Xs2aServices [#green]-> Xs2aServices : Switch to real execution mode
Xs2aServices [#green]-> ASPSP : Initiate consent
ASPSP [#green]-> Xs2aServices : Redirect authorization required
Xs2aServices [#green]-> Xs2aListAccountsEntrypoint : Redirect to ASPSP required
Xs2aListAccountsEntrypoint [#green]-> OutcomeMapper : Translate 'Redirect to ASPSP required'
OutcomeMapper [#green]-> Xs2aListAccountsEntrypoint : ContextBasedAuthorizationRequiredResult
Xs2aListAccountsEntrypoint [#green]-> FacadeService : ContextBasedAuthorizationRequiredResult
FacadeService [#green]-> ProtocolResultHandler : Translate FacadeStartAuthorizationResult -> FacadeRedirectResult
TppBankingApiAisController [#green]-> FacadeResponseMapper : translate FacadeRedirectResult
FacadeResponseMapper [#green]-> TppBankingApiAisController : This is 303 code with redirection to ASPSP authorization page
TppBankingApiAisController [#green]-> TppBackend : 303 Redirect to ASPSP
TppBackend [#green]-> User : 303 ASPSP 'Login page'

== User authorizes this request with ASPSP (redirect) ==
User [#orange]-> ASPSP : Authorization

== ASPSP reports consent authorization OK ==
ASPSP [#magenta]-> User : Done, optionally redirect
ASPSP [#magenta]-> TppBackend : GET /from/aspsp/ok webhook
TppBackend [#magenta]-> ConsentServiceController : fromAspspOkUsingGET
ConsentServiceController [#magenta]-> FacadeService : Facade.execute()
FacadeService [#magenta]-> ServiceContextProvider : Create facade context from request
FacadeService <-[#magenta] ServiceContextProvider : ServiceContext
FacadeService [#magenta]-> ProtocolSelector : Select bank protocol by using authorization session id
ProtocolSelector [#magenta]-> Database : Read authorization session
Database [#magenta]-> ProtocolSelector: Bank protocol id from authorization session
ProtocolSelector [#magenta]-> Database : Read bank protocol using its id
Database [#magenta]-> ProtocolSelector : BankProtocol
ProtocolSelector [#magenta]-> FacadeService : BankProtocol
FacadeService [#magenta]-> Spring : Find bean - Bean(BankProtocol.protocolBeanName) extends Action
FacadeService <-[#magenta] Spring : It is Xs2aFromAspspRedirect service bean
Xs2aFromAspspRedirect [#magenta]-> Xs2aServices : Bank approved consent
Xs2aServices [#magenta]-> Database : Persist consent and its context
Xs2aServices [#magenta]-> Xs2aFromAspspRedirect : Consent acquired
Xs2aFromAspspRedirect [#magenta]-> OutcomeMapper : Translate 'Consent acquired'
OutcomeMapper [#magenta]-> Xs2aFromAspspRedirect : ConsentAcquiredResult
Xs2aFromAspspRedirect [#magenta]-> FacadeService : ConsentAcquiredResult
FacadeService [#magenta]-> ProtocolResultHandler : Translate ConsentAcquiredResult -> FacadeRedirectResult
TppBankingApiAisController [#magenta]-> FacadeResponseMapper : translate FacadeRedirectResult
FacadeResponseMapper [#magenta]-> TppBankingApiAisController : This is 303 code with redirection to FinTech
TppBankingApiAisController [#magenta]-> TppBackend : 303 Redirect to FinTech
TppBackend [#magenta]-> User : 303 FinTech 'Thanks for consent' page

== Fintech receives notification that consent is received ==
User [#orange]-> FinTech

== Fintech calls user account list within same session id ==

FinTech -> TppBackend : GET /accounts\n with <b>service session id</b> and Fintech user info, bank id, etc.
TppBackend -> TppBankingApiAisController : getAccounts
TppBankingApiAisController -> FacadeService : Facade.execute()
FacadeService -> ServiceContextProvider : Create facade context from request
FacadeService <- ServiceContextProvider : ServiceContext
FacadeService -> ProtocolSelector : Select bank protocol from request type and bank id
ProtocolSelector -> Database : Read bank protocol using bank uuid and action id
Database -> ProtocolSelector : BankProtocol
ProtocolSelector -> FacadeService : BankProtocol
FacadeService -> Spring : Find bean - Bean(BankProtocol.protocolBeanName) extends Action
FacadeService <- Spring : It is Xs2aListAccountsEntrypoint service bean
FacadeService -> Xs2aListAccountsEntrypoint : Xs2aListAccountsEntrypoint.execute(ServiceContext)
Xs2aListAccountsEntrypoint -> Database : Consent for service session
Xs2aListAccountsEntrypoint <- Database : Consent present, <b>consent context</b>
Xs2aServices -> Xs2aServices : Validate <b>consent context</b> -\ndo we have enough data (Mocked execution)
Xs2aServices -> ASPSP : Call ASPSP with consent using <b>consent context</b>
ASPSP -> Xs2aServices : Users' accounts
Xs2aServices -> OutcomeMapper : Translate ASPSP response
OutcomeMapper -> Xs2aResultBodyExtractor : Translate ASPSP response
Xs2aResultBodyExtractor -> OutcomeMapper : Account list
OutcomeMapper -> Xs2aListAccountsEntrypoint
Xs2aListAccountsEntrypoint -> FacadeService : SuccessResult<Account list>
Xs2aFromAspspRedirect -> FacadeService : SuccessResult<Account list>
FacadeService -> ProtocolResultHandler : Translate SuccessResult -> FacadeSuccessResult
ProtocolResultHandler -> TppBankingApiAisController : process FacadeSuccessResult
TppBankingApiAisController -> FacadeResponseMapper : translate FacadeSuccessResult
FacadeResponseMapper -> TppBankingApiAisController : This is 200 code with Account list body
TppBankingApiAisController -> TppBackend : 200 and Account list
TppBackend -> FinTech : 200 and Account list
@enduml

PlantUML version 1.2019.11(Sun Sep 22 13:02:15 EEST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_232-release-1638-b6
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
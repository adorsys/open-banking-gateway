<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1090px" preserveAspectRatio="none" style="width:3059px;height:1090px;" version="1.1" viewBox="0 0 3059 1090" width="3059px" zoomAndPan="magnify"><defs><filter height="300%" id="f1gn1csroivco9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1032.3125" style="stroke: #A80036; stroke-width: 1.0;" width="617" x="395.5" y="47.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="57" x="675.5" y="59.3638">TPP API</text><rect fill="#DDDDDD" height="1032.3125" style="stroke: #A80036; stroke-width: 1.0;" width="807" x="1014.5" y="47.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="1368" y="59.3638">OPBA-Facade</text><rect fill="#DDDDDD" height="1032.3125" style="stroke: #A80036; stroke-width: 1.0;" width="1162" x="1823.5" y="47.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="2352.5" y="59.3638">XS2A-Protocol</text><rect fill="#FFFFFF" filter="url(#f1gn1csroivco9)" height="381.8594" style="stroke: #000000; stroke-width: 2.0;" width="2761.5" x="13" y="189.7266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="42" x2="42" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="330" x2="330" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="497.5" x2="497.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="697.5" x2="697.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="912.5" x2="912.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1079.5" x2="1079.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1186.5" x2="1186.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1332.5" x2="1332.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1497.5" x2="1497.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1604.5" x2="1604.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1731.5" x2="1731.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1932.5" x2="1932.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2143.5" x2="2143.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2344.5" x2="2344.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2544.5" x2="2544.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2707.5" x2="2707.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2914.5" x2="2914.5" y1="129.5938" y2="993.3125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3016.5" x2="3016.5" y1="129.5938" y2="993.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="23" y="126.292">User</text><ellipse cx="42" cy="56.2969" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M42,64.2969 L42,91.2969 M29,72.2969 L55,72.2969 M42,91.2969 L29,106.2969 M42,91.2969 L55,106.2969 " fill="none" filter="url(#f1gn1csroivco9)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="23" y="1005.3076">User</text><ellipse cx="42" cy="1018.6094" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M42,1026.6094 L42,1053.6094 M29,1034.6094 L55,1034.6094 M42,1053.6094 L29,1068.6094 M42,1053.6094 L55,1068.6094 " fill="none" filter="url(#f1gn1csroivco9)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="279" y="90.2969"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="275" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="282" y="114.292">TppBackend</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="279" y="992.3125"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="275" y="996.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="282" y="1016.3076">TppBackend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="399.5" y="126.292">TppBankingApiAisController</text><ellipse cx="498" cy="97.2969" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="494,85.2969,500,80.2969,498,85.2969,500,90.2969,494,85.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="399.5" y="1005.3076">TppBankingApiAisController</text><ellipse cx="498" cy="1024.6094" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="494,1012.6094,500,1007.6094,498,1012.6094,500,1017.6094,494,1012.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="176" x="606.5" y="126.292">ConsentServiceController</text><ellipse cx="697.5" cy="97.2969" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="693.5,85.2969,699.5,80.2969,697.5,85.2969,699.5,90.2969,693.5,85.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="176" x="606.5" y="1005.3076">ConsentServiceController</text><ellipse cx="697.5" cy="1024.6094" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="693.5,1012.6094,699.5,1007.6094,697.5,1012.6094,699.5,1017.6094,693.5,1012.6094" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="817.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="824.5" y="114.292">FacadeResponseMapper</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="817.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="824.5" y="1012.3076">FacadeResponseMapper</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1022.5" y="90.2969"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1018.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1025.5" y="114.292">FacadeService</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1022.5" y="992.3125"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1018.5" y="996.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1025.5" y="1016.3076">FacadeService</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1150.5" y="126.292">Database</text><path d="M1168.5,77.2969 C1168.5,67.2969 1186.5,67.2969 1186.5,67.2969 C1186.5,67.2969 1204.5,67.2969 1204.5,77.2969 L1204.5,103.2969 C1204.5,113.2969 1186.5,113.2969 1186.5,113.2969 C1186.5,113.2969 1168.5,113.2969 1168.5,103.2969 L1168.5,77.2969 " fill="#FEFECE" filter="url(#f1gn1csroivco9)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1168.5,77.2969 C1168.5,87.2969 1186.5,87.2969 1186.5,87.2969 C1186.5,87.2969 1204.5,87.2969 1204.5,77.2969 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1150.5" y="1005.3076">Database</text><path d="M1168.5,1018.6094 C1168.5,1008.6094 1186.5,1008.6094 1186.5,1008.6094 C1186.5,1008.6094 1204.5,1008.6094 1204.5,1018.6094 L1204.5,1044.6094 C1204.5,1054.6094 1186.5,1054.6094 1186.5,1054.6094 C1186.5,1054.6094 1168.5,1054.6094 1168.5,1044.6094 L1168.5,1018.6094 " fill="#FEFECE" filter="url(#f1gn1csroivco9)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1168.5,1018.6094 C1168.5,1028.6094 1186.5,1028.6094 1186.5,1028.6094 C1186.5,1028.6094 1204.5,1028.6094 1204.5,1018.6094 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="1243.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="1250.5" y="114.292">ServiceContextProvider</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="1243.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="1250.5" y="1012.3076">ServiceContextProvider</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1431.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1438.5" y="114.292">ProtocolSelector</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1431.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1438.5" y="1012.3076">ProtocolSelector</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="1573.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1580.5" y="114.292">Spring</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="1573.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1580.5" y="1012.3076">Spring</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="1645.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1652.5" y="114.292">ProtocolResultHandler</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="1645.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1652.5" y="1012.3076">ProtocolResultHandler</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="1827.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="1834.5" y="114.292">Xs2aListAccountsEntrypoint</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="1827.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="1834.5" y="1012.3076">Xs2aListAccountsEntrypoint</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="2047.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="2054.5" y="114.292">Xs2aUpdateAuthorization</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="2047.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="2054.5" y="1012.3076">Xs2aUpdateAuthorization</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="184" x="2250.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="170" x="2257.5" y="114.292">Xs2aFromAspspRedirect</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="184" x="2250.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="170" x="2257.5" y="1012.3076">Xs2aFromAspspRedirect</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="2448.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="2455.5" y="114.292">Xs2aResultBodyExtractor</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="2448.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="2455.5" y="1012.3076">Xs2aResultBodyExtractor</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2654.5" y="90.2969"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2650.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="2657.5" y="114.292">Xs2aServices</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2654.5" y="992.3125"/><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="2650.5" y="996.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="2657.5" y="1016.3076">Xs2aServices</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="2847.5" y="94.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="2854.5" y="114.292">OutcomeMapper</text><rect fill="#FEFECE" filter="url(#f1gn1csroivco9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="2847.5" y="992.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="2854.5" y="1012.3076">OutcomeMapper</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="2991.5" y="126.292">ASPSP</text><path d="M2996.5,85.2969 L2996.5,109.2969 M2996.5,97.2969 L3013.5,97.2969 " fill="none" filter="url(#f1gn1csroivco9)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3025.5" cy="97.2969" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="2991.5" y="1005.3076">ASPSP</text><path d="M2996.5,1012.6094 L2996.5,1036.6094 M2996.5,1024.6094 L3013.5,1024.6094 " fill="none" filter="url(#f1gn1csroivco9)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3025.5" cy="1024.6094" fill="#FEFECE" filter="url(#f1gn1csroivco9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#EEEEEE" filter="url(#f1gn1csroivco9)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="3044.5" x="3" y="160.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3047.5" y1="160.1602" y2="160.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="3047.5" y1="163.1602" y2="163.1602"/><rect fill="#EEEEEE" filter="url(#f1gn1csroivco9)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="488" x="1281.25" y="149.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="469" x="1287.25" y="165.6606">User authorizes this request (embedded to provide i.e. PSU id)</text><path d="M13,189.7266 L90,189.7266 L90,196.7266 L80,206.7266 L13,206.7266 L13,189.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="381.8594" style="stroke: #000000; stroke-width: 2.0;" width="2761.5" x="13" y="189.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="28" y="202.7935">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="105" y="201.937">[Until user input has not enough parameters]</text><polygon fill="#008000" points="318,239.125,328,243.125,318,247.125,322,243.125" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="42" x2="324" y1="243.125" y2="243.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="49" y="222.9263">POST /consent/embedded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="49" y="238.0591">(Consent valid until, which accounts, etc.)</text><polygon fill="#008000" points="685.5,268.2578,695.5,272.2578,685.5,276.2578,689.5,272.2578" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="330" x2="691.5" y1="272.2578" y2="272.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="337" y="267.1919">embeddedUsingPOST</text><polygon fill="#008000" points="1067.5,297.3906,1077.5,301.3906,1067.5,305.3906,1071.5,301.3906" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="697.5" x2="1073.5" y1="301.3906" y2="301.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="704.5" y="296.3247">Facade.execute()</text><polygon fill="#008000" points="1320.5,326.5234,1330.5,330.5234,1320.5,334.5234,1324.5,330.5234" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1079.5" x2="1326.5" y1="330.5234" y2="330.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1086.5" y="325.4575">Create facade context from request</text><polygon fill="#008000" points="1090.5,355.6563,1080.5,359.6563,1090.5,363.6563,1086.5,359.6563" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1084.5" x2="1331.5" y1="359.6563" y2="359.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1096.5" y="354.5903">ServiceContext</text><polygon fill="#008000" points="1485.5,384.7891,1495.5,388.7891,1485.5,392.7891,1489.5,388.7891" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1079.5" x2="1491.5" y1="388.7891" y2="388.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1086.5" y="383.7231">Select bank protocol by using authorization session id</text><polygon fill="#008000" points="1197.5,413.9219,1187.5,417.9219,1197.5,421.9219,1193.5,417.9219" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1191.5" x2="1496.5" y1="417.9219" y2="417.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="1203.5" y="412.856">Read authorization session</text><polygon fill="#008000" points="1485.5,443.0547,1495.5,447.0547,1485.5,451.0547,1489.5,447.0547" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1186.5" x2="1491.5" y1="447.0547" y2="447.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1193.5" y="441.9888">Bank protocol id from authorization session</text><polygon fill="#008000" points="1090.5,472.1875,1080.5,476.1875,1090.5,480.1875,1086.5,476.1875" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1084.5" x2="1496.5" y1="476.1875" y2="476.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1096.5" y="471.1216">BankProtocol</text><polygon fill="#008000" points="1592.5,501.3203,1602.5,505.3203,1592.5,509.3203,1596.5,505.3203" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1079.5" x2="1598.5" y1="505.3203" y2="505.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1086.5" y="500.2544">Find bean - Bean(BankProtocol.protocolBeanName) extends Action</text><polygon fill="#008000" points="1090.5,530.4531,1080.5,534.4531,1090.5,538.4531,1086.5,534.4531" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1084.5" x2="1603.5" y1="534.4531" y2="534.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="1096.5" y="529.3872">It is Xs2aUpdateAuthorization service bean</text><polygon fill="#008000" points="2695.5,559.5859,2705.5,563.5859,2695.5,567.5859,2699.5,563.5859" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2144" x2="2701.5" y1="563.5859" y2="563.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="2151" y="558.52">Update context with users' input</text><line style="stroke: #008000; stroke-width: 1.0;" x1="2707.5" x2="2749.5" y1="599.7188" y2="599.7188"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2749.5" x2="2749.5" y1="599.7188" y2="612.7188"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2708.5" x2="2749.5" y1="612.7188" y2="612.7188"/><polygon fill="#008000" points="2718.5,608.7188,2708.5,612.7188,2718.5,616.7188,2714.5,612.7188" style="stroke: #008000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="2714.5" y="594.6528">User input OK</text><line style="stroke: #008000; stroke-width: 1.0;" x1="2707.5" x2="2749.5" y1="641.8516" y2="641.8516"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2749.5" x2="2749.5" y1="641.8516" y2="654.8516"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2708.5" x2="2749.5" y1="654.8516" y2="654.8516"/><polygon fill="#008000" points="2718.5,650.8516,2708.5,654.8516,2718.5,658.8516,2714.5,654.8516" style="stroke: #008000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="2714.5" y="636.7856">Switch to real execution mode</text><polygon fill="#008000" points="3005,679.9844,3015,683.9844,3005,687.9844,3009,683.9844" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2707.5" x2="3011" y1="683.9844" y2="683.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2714.5" y="678.9185">Initiate consent</text><polygon fill="#008000" points="2718.5,709.1172,2708.5,713.1172,2718.5,717.1172,2714.5,713.1172" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="2712.5" x2="3016" y1="713.1172" y2="713.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="2724.5" y="708.0513">Redirect authorization required</text><polygon fill="#008000" points="1943.5,738.25,1933.5,742.25,1943.5,746.25,1939.5,742.25" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1937.5" x2="2706.5" y1="742.25" y2="742.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="1949.5" y="737.1841">Redirect to ASPSP required</text><polygon fill="#008000" points="2902.5,767.3828,2912.5,771.3828,2902.5,775.3828,2906.5,771.3828" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1932.5" x2="2908.5" y1="771.3828" y2="771.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="1939.5" y="766.3169">Translate 'Redirect to ASPSP required'</text><polygon fill="#008000" points="1943.5,796.5156,1933.5,800.5156,1943.5,804.5156,1939.5,800.5156" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1937.5" x2="2913.5" y1="800.5156" y2="800.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1949.5" y="795.4497">ContextBasedAuthorizationRequiredResult</text><polygon fill="#008000" points="1090.5,825.6484,1080.5,829.6484,1090.5,833.6484,1086.5,829.6484" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1084.5" x2="1931.5" y1="829.6484" y2="829.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1096.5" y="824.5825">ContextBasedAuthorizationRequiredResult</text><polygon fill="#008000" points="1719.5,854.7813,1729.5,858.7813,1719.5,862.7813,1723.5,858.7813" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="1079.5" x2="1725.5" y1="858.7813" y2="858.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1086.5" y="853.7153">Translate FacadeStartAuthorizationResult -&gt; FacadeRedirectResult</text><polygon fill="#008000" points="901,883.9141,911,887.9141,901,891.9141,905,887.9141" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="498" x2="907" y1="887.9141" y2="887.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="505" y="882.8481">translate FacadeRedirectResult</text><polygon fill="#008000" points="509,913.0469,499,917.0469,509,921.0469,505,917.0469" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="503" x2="912" y1="917.0469" y2="917.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="515" y="911.981">This is 303 code with redirection to ASPSP authorization page</text><polygon fill="#008000" points="341,942.1797,331,946.1797,341,950.1797,337,946.1797" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="335" x2="497" y1="946.1797" y2="946.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="347" y="941.1138">303 Redirect to ASPSP</text><polygon fill="#008000" points="53,971.3125,43,975.3125,53,979.3125,49,975.3125" style="stroke: #008000; stroke-width: 1.0;"/><line style="stroke: #008000; stroke-width: 1.0;" x1="47" x2="329" y1="975.3125" y2="975.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="59" y="970.2466">303 ASPSP 'Login page'</text><rect fill="#DDDDDD" height="26.2969" rx="5" ry="5" style="stroke: #000000; stroke-width: 1.0;" width="303" x="11" y="11"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="291" x="17" y="28.9951">Embedded initial authorization phase</text><!--MD5=[62e7f89a980f62d5dd030e3bf0c95d36]
@startuml
legend top left
  <b>Embedded initial authorization phase</b>
endlegend

actor User

collections TppBackend

box "TPP API"
control TppBankingApiAisController
control ConsentServiceController
participant FacadeResponseMapper
endbox

box "OPBA-Facade"
collections FacadeService
database Database
participant ServiceContextProvider
participant ProtocolSelector
participant Spring
participant ProtocolResultHandler
endbox

box "XS2A-Protocol"
participant Xs2aListAccountsEntrypoint
participant Xs2aUpdateAuthorization
participant Xs2aFromAspspRedirect
participant Xs2aResultBodyExtractor
collections Xs2aServices
participant OutcomeMapper
endbox

boundary ASPSP

== User authorizes this request (embedded to provide i.e. PSU id) ==
loop Until user input has not enough parameters
User [#green]-> TppBackend : POST /consent/embedded\n(Consent valid until, which accounts, etc.)
TppBackend [#green]-> ConsentServiceController : embeddedUsingPOST
ConsentServiceController [#green]-> FacadeService : Facade.execute()
FacadeService [#green]-> ServiceContextProvider : Create facade context from request
FacadeService <-[#green] ServiceContextProvider : ServiceContext
FacadeService [#green]-> ProtocolSelector : Select bank protocol by using authorization session id
ProtocolSelector [#green]-> Database : Read authorization session
Database [#green]-> ProtocolSelector: Bank protocol id from authorization session
ProtocolSelector [#green]-> FacadeService : BankProtocol
FacadeService [#green]-> Spring : Find bean - Bean(BankProtocol.protocolBeanName) extends Action
FacadeService <-[#green] Spring : It is Xs2aUpdateAuthorization service bean
Xs2aUpdateAuthorization [#green]-> Xs2aServices : Update context with users' input
end
Xs2aServices [#green]-> Xs2aServices : User input OK
Xs2aServices [#green]-> Xs2aServices : Switch to real execution mode
Xs2aServices [#green]-> ASPSP : Initiate consent
ASPSP [#green]-> Xs2aServices : Redirect authorization required
Xs2aServices [#green]-> Xs2aListAccountsEntrypoint : Redirect to ASPSP required
Xs2aListAccountsEntrypoint [#green]-> OutcomeMapper : Translate 'Redirect to ASPSP required'
OutcomeMapper [#green]-> Xs2aListAccountsEntrypoint : ContextBasedAuthorizationRequiredResult
Xs2aListAccountsEntrypoint [#green]-> FacadeService : ContextBasedAuthorizationRequiredResult
FacadeService [#green]-> ProtocolResultHandler : Translate FacadeStartAuthorizationResult -> FacadeRedirectResult
TppBankingApiAisController [#green]-> FacadeResponseMapper : translate FacadeRedirectResult
FacadeResponseMapper [#green]-> TppBankingApiAisController : This is 303 code with redirection to ASPSP authorization page
TppBankingApiAisController [#green]-> TppBackend : 303 Redirect to ASPSP
TppBackend [#green]-> User : 303 ASPSP 'Login page'
@enduml

PlantUML version 1.2019.11(Sun Sep 22 13:02:15 EEST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_232-release-1638-b6
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
